<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.16: http://docutils.sourceforge.net/" />
<title>BREEZE.rst</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<blockquote>
<!-- Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!-- Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License. -->
</blockquote>
<div align="center">
  <img src="images/AirflowBreeze_logo.png"
       alt="Airflow Breeze - Development and Test Environment for Apache Airflow">
</div><div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#airflow-breeze-ci-environment" id="id13">Airflow Breeze CI environment</a></li>
<li><a class="reference internal" href="#prerequisites" id="id14">Prerequisites</a><ul>
<li><a class="reference internal" href="#docker-desktop" id="id15">Docker Desktop</a></li>
<li><a class="reference internal" href="#id2" id="id16">Docker Compose</a></li>
<li><a class="reference internal" href="#docker-in-wsl-2" id="id17">Docker in WSL 2</a></li>
<li><a class="reference internal" href="#the-pipx-tool" id="id18">The pipx tool</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resources-required" id="id19">Resources required</a><ul>
<li><a class="reference internal" href="#memory" id="id20">Memory</a></li>
<li><a class="reference internal" href="#disk" id="id21">Disk</a></li>
<li><a class="reference internal" href="#cleaning-the-environment" id="id22">Cleaning the environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#installation" id="id23">Installation</a><ul>
<li><a class="reference internal" href="#running-breeze-for-the-first-time" id="id24">Running Breeze for the first time</a></li>
<li><a class="reference internal" href="#automating-breeze-installation" id="id25">Automating breeze installation</a></li>
<li><a class="reference internal" href="#customizing-your-environment" id="id26">Customizing your environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regular-development-tasks" id="id27">Regular development tasks</a><ul>
<li><a class="reference internal" href="#entering-breeze-shell" id="id28">Entering Breeze shell</a></li>
<li><a class="reference internal" href="#building-the-documentation" id="id29">Building the documentation</a></li>
<li><a class="reference internal" href="#generating-short-form-names-for-providers" id="id30">Generating short form names for Providers</a></li>
<li><a class="reference internal" href="#running-static-checks" id="id31">Running static checks</a><ul>
<li><a class="reference internal" href="#selecting-files-to-run-static-checks-on" id="id32">Selecting files to run static checks on</a></li>
</ul>
</li>
<li><a class="reference internal" href="#starting-airflow" id="id33">Starting Airflow</a></li>
<li><a class="reference internal" href="#launching-multiple-terminals-in-the-same-environment" id="id34">Launching multiple terminals in the same environment</a></li>
<li><a class="reference internal" href="#compiling-www-assets" id="id35">Compiling www assets</a></li>
<li><a class="reference internal" href="#breeze-cleanup" id="id36">Breeze cleanup</a></li>
<li><a class="reference internal" href="#running-arbitrary-commands-in-container" id="id37">Running arbitrary commands in container</a></li>
<li><a class="reference internal" href="#running-breeze-with-metrics" id="id38">Running Breeze with Metrics</a><ul>
<li><a class="reference internal" href="#running-breeze-with-a-statsd-metrics-stack" id="id39">Running Breeze with a StatsD Metrics Stack</a></li>
<li><a class="reference internal" href="#running-breeze-with-an-opentelemetry-metrics-stack" id="id40">Running Breeze with an OpenTelemetry Metrics Stack</a></li>
<li><a class="reference internal" href="#running-breeze-with-openlineage" id="id41">Running Breeze with OpenLineage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#stopping-the-environment" id="id42">Stopping the environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting" id="id43">Troubleshooting</a><ul>
<li><a class="reference internal" href="#etimeout-error" id="id44">ETIMEOUT Error</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-commands" id="id45">Advanced commands</a><ul>
<li><a class="reference internal" href="#running-tests" id="id46">Running tests</a><ul>
<li><a class="reference internal" href="#iterate-on-tests-interactively-via-shell-command" id="id47">Iterate on tests interactively via <tt class="docutils literal">shell</tt> command</a></li>
<li><a class="reference internal" href="#running-unit-tests-with-breeze-testing-commands" id="id48">Running unit tests with <tt class="docutils literal">breeze testing</tt> commands</a></li>
<li><a class="reference internal" href="#using-breeze-testing-tests-command" id="id49">Using <tt class="docutils literal">breeze testing tests</tt> command</a></li>
<li><a class="reference internal" href="#using-breeze-testing-db-tests-command" id="id50">Using <tt class="docutils literal">breeze testing <span class="pre">db-tests</span></tt> command</a></li>
<li><a class="reference internal" href="#using-breeze-testing-non-db-tests-command" id="id51">Using <tt class="docutils literal">breeze testing <span class="pre">non-db-tests</span></tt> command</a></li>
<li><a class="reference internal" href="#running-integration-tests" id="id52">Running integration tests</a></li>
<li><a class="reference internal" href="#running-helm-unit-tests" id="id53">Running Helm unit tests</a></li>
<li><a class="reference internal" href="#running-docker-compose-tests" id="id54">Running docker-compose tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-kubernetes-tests" id="id55">Running Kubernetes tests</a><ul>
<li><a class="reference internal" href="#setting-up-k8s-environment" id="id56">Setting up K8S environment</a></li>
<li><a class="reference internal" href="#creating-k8s-cluster" id="id57">Creating K8S cluster</a></li>
<li><a class="reference internal" href="#deleting-k8s-cluster" id="id58">Deleting K8S cluster</a></li>
<li><a class="reference internal" href="#building-airflow-k8s-images" id="id59">Building Airflow K8s images</a></li>
<li><a class="reference internal" href="#uploading-airflow-k8s-images" id="id60">Uploading Airflow K8s images</a></li>
<li><a class="reference internal" href="#configuring-k8s-cluster" id="id61">Configuring K8S cluster</a></li>
<li><a class="reference internal" href="#deploying-airflow-to-the-cluster" id="id62">Deploying Airflow to the Cluster</a></li>
<li><a class="reference internal" href="#checking-status-of-the-k8s-cluster" id="id63">Checking status of the K8S cluster</a></li>
<li><a class="reference internal" href="#running-k8s-tests" id="id64">Running k8s tests</a></li>
<li><a class="reference internal" href="#running-k8s-complete-tests" id="id65">Running k8s complete tests</a></li>
<li><a class="reference internal" href="#entering-k8s-shell" id="id66">Entering k8s shell</a></li>
<li><a class="reference internal" href="#running-k9s-tool" id="id67">Running k9s tool</a></li>
<li><a class="reference internal" href="#dumping-logs-from-all-k8s-clusters" id="id68">Dumping logs from all k8s clusters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ci-image-tasks" id="id69">CI Image tasks</a><ul>
<li><a class="reference internal" href="#building-ci-image" id="id70">Building CI image</a></li>
<li><a class="reference internal" href="#pulling-ci-image" id="id71">Pulling CI image</a></li>
<li><a class="reference internal" href="#verifying-ci-image" id="id72">Verifying CI image</a></li>
</ul>
</li>
<li><a class="reference internal" href="#prod-image-tasks" id="id73">PROD Image tasks</a><ul>
<li><a class="reference internal" href="#building-prod-image" id="id74">Building PROD image</a></li>
<li><a class="reference internal" href="#pulling-prod-image" id="id75">Pulling PROD image</a></li>
<li><a class="reference internal" href="#verifying-prod-image" id="id76">Verifying PROD image</a></li>
</ul>
</li>
<li><a class="reference internal" href="#breeze-setup" id="id77">Breeze setup</a><ul>
<li><a class="reference internal" href="#breeze-configuration" id="id78">Breeze configuration</a></li>
<li><a class="reference internal" href="#setting-up-autocompletion" id="id79">Setting up autocompletion</a></li>
<li><a class="reference internal" href="#breeze-version" id="id80">Breeze version</a></li>
<li><a class="reference internal" href="#breeze-setup-self-upgrade" id="id81">Breeze setup self-upgrade</a></li>
<li><a class="reference internal" href="#regenerating-images-for-documentation" id="id82">Regenerating images for documentation</a></li>
<li><a class="reference internal" href="#breeze-check-all-params-in-groups" id="id83">Breeze check-all-params-in-groups</a></li>
<li><a class="reference internal" href="#breeze-synchronize-local-mounts" id="id84">Breeze synchronize-local-mounts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ci-tasks" id="id85">CI tasks</a><ul>
<li><a class="reference internal" href="#running-resource-check" id="id86">Running resource check</a></li>
<li><a class="reference internal" href="#freeing-the-space" id="id87">Freeing the space</a></li>
<li><a class="reference internal" href="#fixing-file-directory-ownership" id="id88">Fixing File/Directory Ownership</a></li>
<li><a class="reference internal" href="#selective-check" id="id89">Selective check</a></li>
<li><a class="reference internal" href="#getting-workflow-information" id="id90">Getting workflow information</a></li>
<li><a class="reference internal" href="#finding-backtracking-candidates" id="id91">Finding backtracking candidates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#release-management-tasks" id="id92">Release management tasks</a><ul>
<li><a class="reference internal" href="#airflow-release-commands" id="id93">Airflow release commands</a><ul>
<li><a class="reference internal" href="#preparing-airflow-packages" id="id94">Preparing airflow packages</a></li>
<li><a class="reference internal" href="#start-minor-branch-of-airflow" id="id95">Start minor branch of Airflow</a></li>
<li><a class="reference internal" href="#start-release-candidate-process" id="id96">Start release candidate process</a></li>
<li><a class="reference internal" href="#start-release-process" id="id97">Start release process</a></li>
<li><a class="reference internal" href="#releasing-production-images" id="id98">Releasing Production images</a></li>
</ul>
</li>
<li><a class="reference internal" href="#provider-release-commands" id="id99">Provider release commands</a><ul>
<li><a class="reference internal" href="#preparing-provider-documentation" id="id100">Preparing provider documentation</a></li>
<li><a class="reference internal" href="#preparing-provider-packages" id="id101">Preparing provider packages</a></li>
<li><a class="reference internal" href="#installing-provider-packages" id="id102">Installing provider packages</a></li>
<li><a class="reference internal" href="#verifying-provider-packages" id="id103">Verifying provider packages</a></li>
<li><a class="reference internal" href="#generating-providers-metadata" id="id104">Generating Providers Metadata</a></li>
<li><a class="reference internal" href="#generating-provider-issue" id="id105">Generating Provider Issue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-release-commands" id="id106">Other release commands</a><ul>
<li><a class="reference internal" href="#publishing-the-documentation" id="id107">Publishing the documentation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11" id="id108">Generating short form names for Providers</a><ul>
<li><a class="reference internal" href="#adding-back-referencing-html-for-the-documentation" id="id109">Adding back referencing HTML for the documentation</a></li>
<li><a class="reference internal" href="#generating-constraints" id="id110">Generating constraints</a></li>
<li><a class="reference internal" href="#updating-constraints" id="id111">Updating constraints</a></li>
<li><a class="reference internal" href="#cleaning-up-of-old-providers" id="id112">Cleaning up of old providers</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sbom-generation-tasks" id="id113">SBOM generation tasks</a><ul>
<li><a class="reference internal" href="#generating-sbom-information" id="id114">Generating SBOM information</a></li>
<li><a class="reference internal" href="#build-all-airflow-images" id="id115">Build all airflow images</a></li>
<li><a class="reference internal" href="#generating-provider-requirements" id="id116">Generating Provider requirements</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#details-of-breeze-usage" id="id117">Details of Breeze usage</a><ul>
<li><a class="reference internal" href="#database-volumes-in-breeze" id="id118">Database volumes in Breeze</a></li>
<li><a class="reference internal" href="#additional-tools" id="id119">Additional tools</a></li>
<li><a class="reference internal" href="#launching-breeze-integrations" id="id120">Launching Breeze integrations</a></li>
<li><a class="reference internal" href="#using-local-virtualenv-environment-in-your-host-ide" id="id121">Using local virtualenv environment in Your Host IDE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#internal-details-of-breeze" id="id122">Internal details of Breeze</a><ul>
<li><a class="reference internal" href="#airflow-directory-structure-inside-container" id="id123">Airflow directory structure inside container</a></li>
<li><a class="reference internal" href="#setting-default-answers-for-user-interaction" id="id124">Setting default answers for user interaction</a></li>
<li><a class="reference internal" href="#mounting-local-sources-to-breeze" id="id125">Mounting Local Sources to Breeze</a></li>
<li><a class="reference internal" href="#port-forwarding" id="id126">Port Forwarding</a></li>
<li><a class="reference internal" href="#managing-dependencies" id="id127">Managing Dependencies</a><ul>
<li><a class="reference internal" href="#python-dependencies" id="id128">Python dependencies</a></li>
<li><a class="reference internal" href="#system-debian-dependencies" id="id129">System (debian) dependencies</a></li>
<li><a class="reference internal" href="#node-yarn-dependencies" id="id130">Node (yarn) dependencies</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#recording-command-output" id="id131">Recording command output</a></li>
<li><a class="reference internal" href="#uninstalling-breeze" id="id132">Uninstalling Breeze</a></li>
<li><a class="reference internal" href="#debugging-developing-breeze" id="id133">Debugging/developing Breeze</a></li>
</ul>
</div>
<div class="section" id="airflow-breeze-ci-environment">
<h1><a class="toc-backref" href="#id13">Airflow Breeze CI environment</a></h1>
<p>Airflow Breeze is an easy-to-use development and test environment using
<a class="reference external" href="https://docs.docker.com/compose/">Docker Compose</a>.
The environment is available for local use and is also used in Airflow's CI tests.</p>
<p>We call it <em>Airflow Breeze</em> as <strong>It's a Breeze to contribute to Airflow</strong>.</p>
<p>The advantages and disadvantages of using the Breeze environment vs. other ways of testing Airflow
are described in <a class="reference external" href="CONTRIBUTING.rst#integration-test-development-environment">CONTRIBUTING.rst</a>.</p>
</div>
<div class="section" id="prerequisites">
<h1><a class="toc-backref" href="#id14">Prerequisites</a></h1>
<div class="section" id="docker-desktop">
<h2><a class="toc-backref" href="#id15">Docker Desktop</a></h2>
<ul class="simple">
<li><strong>Version</strong>: Install the latest stable <a class="reference external" href="https://docs.docker.com/get-docker/">Docker Desktop</a>
and make sure it is in your PATH. <tt class="docutils literal">Breeze</tt> detects if you are using version that is too
old and warns you to upgrade.</li>
<li><strong>Permissions</strong>: Configure to run the <tt class="docutils literal">docker</tt> commands directly and not only via root user.
Your user should be in the <tt class="docutils literal">docker</tt> group.
See <a class="reference external" href="https://docs.docker.com/install/">Docker installation guide</a> for details.</li>
<li><strong>Disk space</strong>: On macOS, increase your available disk space before starting to work with
the environment. At least 20 GB of free disk space is recommended. You can also get by with a
smaller space but make sure to clean up the Docker disk space periodically.
See also <a class="reference external" href="https://docs.docker.com/docker-for-mac/space">Docker for Mac - Space</a> for details
on increasing disk space available for Docker on Mac.</li>
<li><strong>Docker problems</strong>: Sometimes it is not obvious that space is an issue when you run into
a problem with Docker. If you see a weird behaviour, try <tt class="docutils literal">breeze cleanup</tt> command.
Also see <a class="reference external" href="https://docs.docker.com/config/pruning/">pruning</a> instructions from Docker.</li>
<li><strong>Docker context</strong>: Recent versions of Docker Desktop are by default configured to use <tt class="docutils literal"><span class="pre">desktop-linux</span></tt>
docker context that uses docker socket created in user home directory. Older versions (and plain docker)
uses <tt class="docutils literal">/var/run/docker.sock</tt> socket and <tt class="docutils literal">default</tt> context. Breeze will attempt to detect if you have
<tt class="docutils literal"><span class="pre">desktop-linux</span></tt> context configured and will use it if it is available, but you can force the
context by adding <tt class="docutils literal"><span class="pre">--builder</span></tt> flag to the commands that build image or run the container and forward
the socket to inside the image.</li>
</ul>
<p>Here is an example configuration with more than 200GB disk space for Docker:</p>
<div align="center">
    <img src="images/disk_space_osx.png" width="640"
         alt="Disk space MacOS">
</div><ul class="simple">
<li><strong>Docker is not running</strong> - even if it is running with Docker Desktop. This is an issue
specific to Docker Desktop 4.13.0 (released in late October 2022). Please upgrade Docker
Desktop to 4.13.1 or later to resolve the issue. For technical details, see also
<a class="reference external" href="https://github.com/docker/for-mac/issues/6529">docker/for-mac#6529</a>.</li>
</ul>
<p><strong>Docker errors that may come while running breeze</strong></p>
<ul class="simple">
<li>If docker not running in python virtual environment</li>
<li><strong>Solution</strong></li>
<li><ol class="first arabic">
<li>Create the docker group if it does not exist</li>
</ol>
</li>
<li><tt class="docutils literal">sudo groupadd docker</tt></li>
<li><ol class="first arabic" start="2">
<li>Add your user to the docker group.</li>
</ol>
</li>
<li><tt class="docutils literal">sudo usermod <span class="pre">-aG</span> docker $USER</tt></li>
<li><ol class="first arabic" start="3">
<li>Log in to the new docker group</li>
</ol>
</li>
<li><tt class="docutils literal">newgrp docker</tt></li>
<li><ol class="first arabic" start="4">
<li>Check if docker can be run without root</li>
</ol>
</li>
<li><tt class="docutils literal">docker run <span class="pre">hello-world</span></tt></li>
<li>5. In some cases you might make sure that &quot;Allow the default Docker socket to
be used&quot; in &quot;Advanced&quot; tab of &quot;Docker Desktop&quot; settings is checked</li>
</ul>
<div align="center">
     <img src="images/docker_socket.png" width="640"
          alt="Docker socket used">
 </div><p>Note: If you use Colima, please follow instructions at: <a class="reference external" href="https://github.com/apache/airflow/blob/main/CONTRIBUTORS_QUICK_START.rst">Contributors Quick Start Guide</a></p>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id16">Docker Compose</a></h2>
<ul>
<li><div class="first system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">BREEZE.rst</tt>, line 40); <em><a href="#id3">backlink</a></em></p>
<p>Duplicate explicit target name: &quot;docker compose&quot;.</p>
</div>
<p><strong>Version</strong>: Install the latest stable <a class="reference external" href="https://docs.docker.com/compose/install/">Docker Compose</a>
and add it to the PATH. <tt class="docutils literal">Breeze</tt> detects if you are using version that is too old and warns you to upgrade.</p>
</li>
<li><p class="first"><strong>Permissions</strong>: Configure permission to be able to run the <tt class="docutils literal"><span class="pre">docker-compose</span></tt> command by your user.</p>
</li>
</ul>
</div>
<div class="section" id="docker-in-wsl-2">
<h2><a class="toc-backref" href="#id17">Docker in WSL 2</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt><strong>WSL 2 installation</strong> :</dt>
<dd>Install WSL 2 and a Linux Distro (e.g. Ubuntu) see
<a class="reference external" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">WSL 2 Installation Guide</a> for details.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Docker Desktop installation</strong> :</dt>
<dd>Install Docker Desktop for Windows. For Windows Home follow the
<a class="reference external" href="https://docs.docker.com/docker-for-windows/install-windows-home">Docker Windows Home Installation Guide</a>.
For Windows Pro, Enterprise, or Education follow the
<a class="reference external" href="https://docs.docker.com/docker-for-windows/install/">Docker Windows Installation Guide</a>.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Docker setting</strong> :</dt>
<dd>WSL integration needs to be enabled</dd>
</dl>
</li>
</ul>
<div align="center">
    <img src="images/docker_wsl_integration.png" width="640"
         alt="Airflow Breeze - Docker WSL2 integration">
</div><ul class="simple">
<li><dl class="first docutils">
<dt><strong>WSL 2 Filesystem Performance</strong> :</dt>
<dd>Accessing the host Windows filesystem incurs a performance penalty,
it is therefore recommended to do development on the Linux filesystem.
E.g. Run <tt class="docutils literal">cd ~</tt> and create a development folder in your Linux distro home
and git pull the Airflow repo there.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>WSL 2 Docker mount errors</strong>:</dt>
<dd>Another reason to use Linux filesystem, is that sometimes - depending on the length of
your path, you might get strange errors when you try start <tt class="docutils literal">Breeze</tt>, such as
<tt class="docutils literal">caused: mount through procfd: not a directory: unknown:</tt>. Therefore checking out
Airflow in Windows-mounted Filesystem is strongly discouraged.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>WSL 2 Docker volume remount errors</strong>:</dt>
<dd>If you're experiencing errors such as <tt class="docutils literal">ERROR: for <span class="pre">docker-compose_airflow_run</span>
Cannot create container for service airflow: not a directory</tt> when starting Breeze
after the first time or an error like <tt class="docutils literal">docker: Error response from daemon: not a directory.
See 'docker run <span class="pre">--help'.</span></tt> when running the pre-commit tests, you may need to consider
<a class="reference external" href="https://dev.to/bowmanjd/install-docker-on-windows-wsl-without-docker-desktop-34m9">installing Docker directly in WSL 2</a>
instead of using Docker Desktop for Windows.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>WSL 2 Memory Usage</strong> :</dt>
<dd>WSL 2 can consume a lot of memory under the process name &quot;Vmmem&quot;. To reclaim the memory after
development you can:<ul class="last">
<li>On the Linux distro clear cached memory: <tt class="docutils literal">sudo sysctl <span class="pre">-w</span> vm.drop_caches=3</tt></li>
<li>If no longer using Docker you can quit Docker Desktop
(right click system try icon and select &quot;Quit Docker Desktop&quot;)</li>
<li>If no longer using WSL you can shut it down on the Windows Host
with the following command: <tt class="docutils literal">wsl <span class="pre">--shutdown</span></tt></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Developing in WSL 2</strong>:</dt>
<dd>You can use all the standard Linux command line utilities to develop on WSL 2.
Further VS Code supports developing in Windows but remotely executing in WSL.
If VS Code is installed on the Windows host system then in the WSL Linux Distro
you can run <tt class="docutils literal">code .</tt> in the root directory of you Airflow repo to launch VS Code.</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="the-pipx-tool">
<h2><a class="toc-backref" href="#id18">The pipx tool</a></h2>
<p>We are using <tt class="docutils literal">pipx</tt> tool to install and manage Breeze. The <tt class="docutils literal">pipx</tt> tool is created by the creators
of <tt class="docutils literal">pip</tt> from <a class="reference external" href="https://www.pypa.io/en/latest/">Python Packaging Authority</a></p>
<p>Note that <tt class="docutils literal">pipx</tt> &gt;= 1.4.1 is used.</p>
<p>Install pipx</p>
<pre class="code bash literal-block">
pip<span class="whitespace"> </span>install<span class="whitespace"> </span>--user<span class="whitespace"> </span><span class="literal string double">&quot;pipx&gt;=1.4.1&quot;</span>
</pre>
<p>Breeze, is not globally accessible until your PATH is updated. Add &lt;USER FOLDER&gt;.localbin as a variable
environments. This can be done automatically by the following command (follow instructions printed).</p>
<pre class="code bash literal-block">
pipx<span class="whitespace"> </span>ensurepath
</pre>
<p>In Mac</p>
<pre class="code bash literal-block">
python<span class="whitespace"> </span>-m<span class="whitespace"> </span>pipx<span class="whitespace"> </span>ensurepath
</pre>
</div>
</div>
<div class="section" id="resources-required">
<h1><a class="toc-backref" href="#id19">Resources required</a></h1>
<div class="section" id="memory">
<h2><a class="toc-backref" href="#id20">Memory</a></h2>
<p>Minimum 4GB RAM for Docker Engine is required to run the full Breeze environment.</p>
<p>On macOS, 2GB of RAM are available for your Docker containers by default, but more memory is recommended
(4GB should be comfortable). For details see
<a class="reference external" href="https://docs.docker.com/v17.12/docker-for-mac/#advanced-tab">Docker for Mac - Advanced tab</a>.</p>
<p>On Windows WSL 2 expect the Linux Distro and Docker containers to use 7 - 8 GB of RAM.</p>
</div>
<div class="section" id="disk">
<h2><a class="toc-backref" href="#id21">Disk</a></h2>
<p>Minimum 40GB free disk space is required for your Docker Containers.</p>
<p>On Mac OS This might deteriorate over time so you might need to increase it or run <tt class="docutils literal">breeze cleanup</tt>
periodically. For details see
<a class="reference external" href="https://docs.docker.com/v17.12/docker-for-mac/#advanced-tab">Docker for Mac - Advanced tab</a>.</p>
<p>On WSL2 you might want to increase your Virtual Hard Disk by following:
<a class="reference external" href="https://docs.microsoft.com/en-us/windows/wsl/compare-versions#expanding-the-size-of-your-wsl-2-virtual-hard-disk">Expanding the size of your WSL 2 Virtual Hard Disk</a></p>
<p>There is a command <tt class="docutils literal">breeze ci <span class="pre">resource-check</span></tt> that you can run to check available resources. See below
for details.</p>
</div>
<div class="section" id="cleaning-the-environment">
<h2><a class="toc-backref" href="#id22">Cleaning the environment</a></h2>
<p>You may need to clean up your Docker environment occasionally. The images are quite big
(1.5GB for both images needed for static code analysis and CI tests) and, if you often rebuild/update
them, you may end up with some unused image data.</p>
<p>To clean up the Docker environment:</p>
<ol class="arabic">
<li><p class="first">Stop Breeze with <tt class="docutils literal">breeze down</tt>. (If Breeze is already running)</p>
</li>
<li><p class="first">Run the <tt class="docutils literal">breeze cleanup</tt> command.</p>
</li>
<li><p class="first">Run <tt class="docutils literal">docker images <span class="pre">--all</span></tt> and <tt class="docutils literal">docker ps <span class="pre">--all</span></tt> to verify that your Docker is clean.</p>
<p>Both commands should return an empty list of images and containers respectively.</p>
</li>
</ol>
<p>If you run into disk space errors, consider pruning your Docker images with the <tt class="docutils literal">docker system prune <span class="pre">--all</span></tt>
command. You may need to restart the Docker Engine before running this command.</p>
<p>In case of disk space errors on macOS, increase the disk space available for Docker. See
<a class="reference external" href="#prerequisites">Prerequisites</a> for details.</p>
</div>
</div>
<div class="section" id="installation">
<h1><a class="toc-backref" href="#id23">Installation</a></h1>
<p>Set your working directory to root of (this) cloned repository.
Run this command to install Breeze (make sure to use <tt class="docutils literal"><span class="pre">-e</span></tt> flag):</p>
<pre class="code bash literal-block">
pipx<span class="whitespace"> </span>install<span class="whitespace"> </span>-e<span class="whitespace"> </span>./dev/breeze
</pre>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>If you see below warning - it means that you hit <a class="reference external" href="https://github.com/pypa/pipx/issues/1092">known issue</a>
with <tt class="docutils literal">packaging</tt> version 23.2:
⚠️ Ignoring --editable install option. pipx disallows it for anything but a local path,
to avoid having to create a new src/ directory.</p>
<p class="last">The workaround is to downgrade packaging to 23.1 and re-running the <tt class="docutils literal">pipx install</tt> command.</p>
<!-- code-block::bash

pip install "packaging<23.2"
pipx install -e ./dev/breeze - -force -->
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note for Windows users</p>
<p>The <tt class="docutils literal">./dev/breeze</tt> in command about is a PATH to sub-folder where breeze source packages are.
If you are on Windows, you should use Windows way to point to the <tt class="docutils literal">dev/breeze</tt> sub-folder
of Airflow either as absolute or relative path. For example:</p>
<pre class="code bash last literal-block">
pipx<span class="whitespace"> </span>install<span class="whitespace"> </span>-e<span class="whitespace"> </span>dev<span class="literal string escape">\b</span>reeze
</pre>
</div>
<p>Once this is complete, you should have <tt class="docutils literal">breeze</tt> binary on your PATH and available to run by <tt class="docutils literal">breeze</tt>
command.</p>
<p>Those are all available commands for Breeze and details about the commands are described below:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output-commands.svg"><object data="./images/breeze/output-commands.svg" style="width: 100%;" type="image/svg+xml">Breeze commands</object></a>
<p>Breeze installed this way is linked to your checked out sources of Airflow, so Breeze will
automatically use latest version of sources from <tt class="docutils literal">./dev/breeze</tt>. Sometimes, when dependencies are
updated <tt class="docutils literal">breeze</tt> commands with offer you to run self-upgrade.</p>
<p>You can always run such self-upgrade at any time:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>setup<span class="whitespace"> </span>self-upgrade
</pre>
<p>If you have several checked out Airflow sources, Breeze will warn you if you are using it from a different
source tree and will offer you to re-install from those sources - to make sure that you are using the right
version.</p>
<p>You can skip Breeze's upgrade check by setting <tt class="docutils literal">SKIP_BREEZE_UPGRADE_CHECK</tt> variable to non empty value.</p>
<p>By default Breeze works on the version of Airflow that you run it in - in case you are outside of the
sources of Airflow and you installed Breeze from a directory - Breeze will be run on Airflow sources from
where it was installed.</p>
<p>You can run <tt class="docutils literal">breeze setup version</tt> command to see where breeze installed from and what are the current sources
that Breeze works on</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Upgrading from earlier Python version</p>
<p>If you used Breeze with Python 3.7 and when running it, it will complain that it needs Python 3.8. In this
case you should force-reinstall Breeze with <tt class="docutils literal">pipx</tt>:</p>
<blockquote>
<pre class="code bash literal-block">
pipx<span class="whitespace"> </span>install<span class="whitespace"> </span>--force<span class="whitespace"> </span>-e<span class="whitespace"> </span>./dev/breeze
</pre>
</blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note for Windows users</p>
<p>The <tt class="docutils literal">./dev/breeze</tt> in command about is a PATH to sub-folder where breeze source packages are.
If you are on Windows, you should use Windows way to point to the <tt class="docutils literal">dev/breeze</tt> sub-folder
of Airflow either as absolute or relative path. For example:</p>
<pre class="code bash last literal-block">
pipx<span class="whitespace"> </span>install<span class="whitespace"> </span>--force<span class="whitespace"> </span>-e<span class="whitespace"> </span>dev<span class="literal string escape">\b</span>reeze
</pre>
</div>
<div class="admonition note last">
<p class="first admonition-title">Note</p>
<p>creating pipx virtual env <tt class="docutils literal"><span class="pre">apache-airflow-breeze</span></tt> with a specific python version</p>
<p>In <tt class="docutils literal">pipx install <span class="pre">--force</span> <span class="pre">-e</span> ./dev/breeze</tt> or <tt class="docutils literal">pipx install <span class="pre">--force</span> <span class="pre">-e</span> dev\breeze</tt>, <tt class="docutils literal">pipx</tt> uses default system python version to create virtual env for breeze.
We can use a specific version by providing python executable in <tt class="docutils literal"><span class="pre">--python</span></tt>  argument. For example:</p>
<pre class="code bash last literal-block">
pipx<span class="whitespace"> </span>install<span class="whitespace"> </span>-e<span class="whitespace"> </span>./dev/breeze<span class="whitespace"> </span>--force<span class="whitespace"> </span>--python<span class="whitespace"> </span>/Users/airflow/.pyenv/versions/3.8.16/bin/python
</pre>
</div>
</div>
<div class="section" id="running-breeze-for-the-first-time">
<h2><a class="toc-backref" href="#id24">Running Breeze for the first time</a></h2>
<p>The First time you run Breeze, it pulls and builds a local version of Docker images.
It pulls the latest Airflow CI images from the
<a class="reference external" href="https://github.com/orgs/apache/packages?repo_name=airflow">GitHub Container Registry</a>
and uses them to build your local Docker images. Note that the first run (per python) might take up to 10
minutes on a fast connection to start. Subsequent runs should be much faster.</p>
<p>Once you enter the environment, you are dropped into bash shell of the Airflow container and you can
run tests immediately.</p>
<p>To use the full potential of breeze you should set up autocomplete. The <tt class="docutils literal">breeze</tt> command comes
with a built-in bash/zsh/fish autocomplete setup command. After installing,
when you start typing the command, you can use &lt;TAB&gt; to show all the available switches and get
auto-completion on typical values of parameters that you can use.</p>
<p>You should set up the autocomplete option automatically by running:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>setup<span class="whitespace"> </span>autocomplete
</pre>
</div>
<div class="section" id="automating-breeze-installation">
<h2><a class="toc-backref" href="#id25">Automating breeze installation</a></h2>
<p>Breeze on POSIX-compliant systems (Linux, MacOS) can be automatically installed by running the
<tt class="docutils literal">scripts/tools/setup_breeze</tt> bash script. This includes checking and installing <tt class="docutils literal">pipx</tt>, setting up
<tt class="docutils literal">breeze</tt> with it and setting up autocomplete.</p>
</div>
<div class="section" id="customizing-your-environment">
<h2><a class="toc-backref" href="#id26">Customizing your environment</a></h2>
<p>When you enter the Breeze environment, automatically an environment file is sourced from
<tt class="docutils literal"><span class="pre">files/airflow-breeze-config/variables.env</span></tt>.</p>
<p>You can also add <tt class="docutils literal"><span class="pre">files/airflow-breeze-config/init.sh</span></tt> and the script will be sourced always
when you enter Breeze. For example you can add <tt class="docutils literal">pip install</tt> commands if you want to install
custom dependencies - but there are no limits to add your own customizations.</p>
<p>You can override the name of the init script by setting <tt class="docutils literal">INIT_SCRIPT_FILE</tt> environment variable before
running the breeze environment.</p>
<p>You can also customize your environment by setting <tt class="docutils literal">BREEZE_INIT_COMMAND</tt> environment variable. This variable
will be evaluated at entering the environment.</p>
<p>The <tt class="docutils literal">files</tt> folder from your local sources is automatically mounted to the container under
<tt class="docutils literal">/files</tt> path and you can put there any files you want to make available for the Breeze container.</p>
<p>You can also copy any .whl or .sdist packages to dist and when you pass <tt class="docutils literal"><span class="pre">--use-packages-from-dist</span></tt> flag
as <tt class="docutils literal">wheel</tt> or <tt class="docutils literal">sdist</tt> line parameter, breeze will automatically install the packages found there
when you enter Breeze.</p>
<p>You can also add your local tmux configuration in <tt class="docutils literal"><span class="pre">files/airflow-breeze-config/.tmux.conf</span></tt> and
these configurations will be available for your tmux environment.</p>
<p>There is a symlink between <tt class="docutils literal"><span class="pre">files/airflow-breeze-config/.tmux.conf</span></tt> and <tt class="docutils literal"><span class="pre">~/.tmux.conf</span></tt> in the container,
so you can change it at any place, and run</p>
<pre class="code bash literal-block">
tmux<span class="whitespace"> </span><span class="name builtin">source</span><span class="whitespace"> </span>~/.tmux.conf
</pre>
<p>inside container, to enable modified tmux configurations.</p>
</div>
</div>
<div class="section" id="regular-development-tasks">
<h1><a class="toc-backref" href="#id27">Regular development tasks</a></h1>
<p>The regular Breeze development tasks are available as top-level commands. Those tasks are most often
used during the development, that's why they are available without any sub-command. More advanced
commands are separated to sub-commands.</p>
<div class="section" id="entering-breeze-shell">
<h2><a class="toc-backref" href="#id28">Entering Breeze shell</a></h2>
<p>This is the most often used feature of breeze. It simply allows to enter the shell inside the Breeze
development environment (inside the Breeze container).</p>
<p>You can use additional <tt class="docutils literal">breeze</tt> flags to choose your environment. You can specify a Python
version to use, and backend (the meta-data database). Thanks to that, with Breeze, you can recreate the same
environments as we have in matrix builds in the CI.</p>
<p>For example, you can choose to run Python 3.8 tests with MySQL as backend and with mysql version 8
as follows:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>--python<span class="whitespace"> </span><span class="literal number">3</span>.8<span class="whitespace"> </span>--backend<span class="whitespace"> </span>mysql<span class="whitespace"> </span>--mysql-version<span class="whitespace"> </span><span class="literal number">8</span>.0
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note for Windows WSL2 users</p>
<p class="last">You may find error messages:</p>
</div>
<pre class="code bash literal-block">
Current<span class="whitespace"> </span>context<span class="whitespace"> </span>is<span class="whitespace"> </span>now<span class="whitespace"> </span><span class="literal string double">&quot;...&quot;</span><span class="whitespace">
</span>protocol<span class="whitespace"> </span>not<span class="whitespace"> </span>available<span class="whitespace">
</span>Error<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>returned
</pre>
<p>Try adding <tt class="docutils literal"><span class="pre">--builder=default</span></tt> to your command. For example:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>--builder<span class="operator">=</span>default<span class="whitespace"> </span>--python<span class="whitespace"> </span><span class="literal number">3</span>.8<span class="whitespace"> </span>--backend<span class="whitespace"> </span>mysql<span class="whitespace"> </span>--mysql-version<span class="whitespace"> </span><span class="literal number">8</span>.0
</pre>
<p>The choices you make are persisted in the <tt class="docutils literal"><span class="pre">./.build/</span></tt> cache directory so that next time when you use the
<tt class="docutils literal">breeze</tt> script, it could use the values that were used previously. This way you do not have to specify
them when you run the script. You can delete the <tt class="docutils literal">.build/</tt> directory in case you want to restore the
default settings.</p>
<p>You can also run breeze with <tt class="docutils literal">SKIP_SAVING_CHOICES</tt> to non-empty value and breeze invocation will not save
used cache value to cache - this is useful when you run non-interactive scripts with <tt class="docutils literal">breeze shell</tt> and
want to - for example - force Python version used only for that execution without changing the Python version
that user used last time.</p>
<p>You can see which value of the parameters that can be stored persistently in cache marked with &gt;VALUE&lt;
in the help of the commands (for example in output of <tt class="docutils literal">breeze config <span class="pre">--help</span></tt>).</p>
</div>
<div class="section" id="building-the-documentation">
<h2><a class="toc-backref" href="#id29">Building the documentation</a></h2>
<p>To build documentation in Breeze, use the <tt class="docutils literal"><span class="pre">build-docs</span></tt> command:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>build-docs
</pre>
<p>Results of the build can be found in the <tt class="docutils literal">docs/_build</tt> folder.</p>
<p>The documentation build consists of three steps:</p>
<ul class="simple">
<li>verifying consistency of indexes</li>
<li>building documentation</li>
<li>spell checking</li>
</ul>
<p>You can choose only one stage of the two by providing <tt class="docutils literal"><span class="pre">--spellcheck-only</span></tt> or <tt class="docutils literal"><span class="pre">--docs-only</span></tt> after
extra <tt class="docutils literal"><span class="pre">--</span></tt> flag.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>build-docs<span class="whitespace"> </span>--spellcheck-only
</pre>
<p>This process can take some time, so in order to make it shorter you can filter by package, using the flag
<tt class="docutils literal"><span class="pre">--package-filter</span> <span class="pre">&lt;PACKAGE-NAME&gt;</span></tt>. The package name has to be one of the providers or <tt class="docutils literal"><span class="pre">apache-airflow</span></tt>. For
instance, for using it with Amazon, the command would be:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>build-docs<span class="whitespace"> </span>--package-filter<span class="whitespace"> </span>apache-airflow-providers-amazon
</pre>
<p>You can also use shorthand names as arguments instead of using the full names
for airflow providers. To find the short hand names, follow the instructions in <a href="#id6"><span class="problematic" id="id7">:ref:`generating_short_form_names`</span></a>.</p>
<div class="system-message" id="id6">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">BREEZE.rst</tt>, line 501); <em><a href="#id7">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<p>Often errors during documentation generation come from the docstrings of auto-api generated classes.
During the docs building auto-api generated files are stored in the <tt class="docutils literal">docs/_api</tt> folder. This helps you
easily identify the location the problems with documentation originated from.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">build-docs</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_build-docs.svg"><object data="./images/breeze/output_build-docs.svg" style="width: 100%;" type="image/svg+xml">Breeze build documentation</object></a>
</div>
<div class="section" id="generating-short-form-names-for-providers">
<span id="generating-short-form-names"></span><h2><a class="toc-backref" href="#id30">Generating short form names for Providers</a></h2>
<p>Skip the <tt class="docutils literal"><span class="pre">apache-airflow-providers-</span></tt> from the usual provider full names.
Now with the remaining part, replace every <tt class="docutils literal"><span class="pre">dash(&quot;-&quot;)</span></tt> with a <tt class="docutils literal"><span class="pre">dot(&quot;.&quot;)</span></tt>.</p>
<p>Example:
If the provider name is <tt class="docutils literal"><span class="pre">apache-airflow-providers-cncf-kubernetes</span></tt>, it will be <tt class="docutils literal">cncf.kubernetes</tt>.</p>
<p>Note: For building docs for apache-airflow-providers index, use <tt class="docutils literal"><span class="pre">apache-airflow-providers</span></tt>
as the short hand operator.</p>
</div>
<div class="section" id="running-static-checks">
<h2><a class="toc-backref" href="#id31">Running static checks</a></h2>
<p>You can run static checks via Breeze. You can also run them via pre-commit command but with auto-completion
Breeze makes it easier to run selective static checks. If you press &lt;TAB&gt; after the static-check and if
you have auto-complete setup you should see auto-completable list of all checks available.</p>
<p>For example, this following command:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>static-checks<span class="whitespace"> </span>--type<span class="whitespace"> </span>mypy-core
</pre>
<p>will run mypy check for currently staged files inside <tt class="docutils literal">airflow/</tt> excluding providers.</p>
<div class="section" id="selecting-files-to-run-static-checks-on">
<h3><a class="toc-backref" href="#id32">Selecting files to run static checks on</a></h3>
<p>Pre-commits run by default on staged changes that you have locally changed. It will run it on all the
files you run <tt class="docutils literal">git add</tt> on and it will ignore any changes that you have modified but not staged.
If you want to run it on all your modified files you should add them with <tt class="docutils literal">git add</tt> command.</p>
<p>With <tt class="docutils literal"><span class="pre">--all-files</span></tt> you can run static checks on all files in the repository. This is useful when you
want to be sure they will not fail in CI, or when you just rebased your changes and want to
re-run latest pre-commits on your changes, but it can take a long time (few minutes) to wait for the result.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>static-checks<span class="whitespace"> </span>--type<span class="whitespace"> </span>mypy-core<span class="whitespace"> </span>--all-files
</pre>
<p>The above will run mypy check for all files.</p>
<p>You can limit that by selecting specific files you want to run static checks on. You can do that by
specifying (can be multiple times) <tt class="docutils literal"><span class="pre">--file</span></tt> flag.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>static-checks<span class="whitespace"> </span>--type<span class="whitespace"> </span>mypy-core<span class="whitespace"> </span>--file<span class="whitespace"> </span>airflow/utils/code_utils.py<span class="whitespace"> </span>--file<span class="whitespace"> </span>airflow/utils/timeout.py
</pre>
<p>The above will run mypy check for those to files (note: autocomplete should work for the file selection).</p>
<p>However, often you do not remember files you modified and you want to run checks for files that belong
to specific commits you already have in your branch. You can use <tt class="docutils literal">breeze static check</tt> to run the checks
only on changed files you have already committed to your branch - either for specific commit, for last
commit, for all changes in your branch since you branched off from main or for specific range
of commits you choose.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>static-checks<span class="whitespace"> </span>--type<span class="whitespace"> </span>mypy-core<span class="whitespace"> </span>--last-commit
</pre>
<p>The above will run mypy check for all files in the last commit in your branch.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>static-checks<span class="whitespace"> </span>--type<span class="whitespace"> </span>mypy-core<span class="whitespace"> </span>--only-my-changes
</pre>
<p>The above will run mypy check for all commits in your branch which were added since you branched off from main.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>static-checks<span class="whitespace"> </span>--type<span class="whitespace"> </span>mypy-core<span class="whitespace"> </span>--commit-ref<span class="whitespace"> </span>639483d998ecac64d0fef7c5aa4634414065f690
</pre>
<p>The above will run mypy check for all files in the 639483d998ecac64d0fef7c5aa4634414065f690 commit.
Any <tt class="docutils literal"><span class="pre">commit-ish</span></tt> reference from Git will work here (branch, tag, short/long hash etc.)</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>static-checks<span class="whitespace"> </span>--type<span class="whitespace"> </span>identity<span class="whitespace"> </span>--verbose<span class="whitespace"> </span>--from-ref<span class="whitespace"> </span>HEAD^^^^<span class="whitespace"> </span>--to-ref<span class="whitespace"> </span>HEAD
</pre>
<p>The above will run the check for the last 4 commits in your branch. You can use any <tt class="docutils literal"><span class="pre">commit-ish</span></tt> references
in <tt class="docutils literal"><span class="pre">--from-ref</span></tt> and <tt class="docutils literal"><span class="pre">--to-ref</span></tt> flags.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">static-checks</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_static-checks.svg"><object data="./images/breeze/output_static-checks.svg" style="width: 100%;" type="image/svg+xml">Breeze static checks</object></a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When you run static checks, some of the artifacts (mypy_cache) is stored in docker-compose volume
so that it can speed up static checks execution significantly. However, sometimes, the cache might
get broken, in which case you should run <tt class="docutils literal">breeze down</tt> to clean up the cache.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You cannot change Python version for static checks that are run within Breeze containers.
The <tt class="docutils literal"><span class="pre">--python</span></tt> flag has no effect for them. They are always run with lowest supported Python version.
The main reason is to keep consistency in the results of static checks and to make sure that
our code is fine when running the lowest supported version.</p>
</div>
</div>
</div>
<div class="section" id="starting-airflow">
<h2><a class="toc-backref" href="#id33">Starting Airflow</a></h2>
<p>For testing Airflow you often want to start multiple components (in multiple terminals). Breeze has
built-in <tt class="docutils literal"><span class="pre">start-airflow</span></tt> command that start breeze container, launches multiple terminals using tmux
and launches all Airflow necessary components in those terminals.</p>
<p>When you are starting airflow from local sources, www asset compilation is automatically executed before.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>--python<span class="whitespace"> </span><span class="literal number">3</span>.8<span class="whitespace"> </span>--backend<span class="whitespace"> </span>mysql<span class="whitespace"> </span>start-airflow
</pre>
<p>You can also use it to start different executor.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>start-airflow<span class="whitespace"> </span>--executor<span class="whitespace"> </span>CeleryExecutor
</pre>
<p>You can also use it to start any released version of Airflow from <tt class="docutils literal">PyPI</tt> with the
<tt class="docutils literal"><span class="pre">--use-airflow-version</span></tt> flag - useful for testing and looking at issues raised for specific version.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>start-airflow<span class="whitespace"> </span>--python<span class="whitespace"> </span><span class="literal number">3</span>.8<span class="whitespace"> </span>--backend<span class="whitespace"> </span>mysql<span class="whitespace"> </span>--use-airflow-version<span class="whitespace"> </span><span class="literal number">2</span>.7.0
</pre>
<p>When you are installing version from PyPI, it's also possible to specify extras that should be used
when installing Airflow - you can provide several extras separated by coma - for example to install
providers together with Airflow that you are installing. For example when you are using celery executor
in Airflow 2.7.0+ you need to add <tt class="docutils literal">celery</tt> extra.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>start-airflow<span class="whitespace"> </span>--use-airflow-version<span class="whitespace"> </span><span class="literal number">2</span>.7.0<span class="whitespace"> </span>--executor<span class="whitespace"> </span>CeleryExecutor<span class="whitespace"> </span>--airflow-extras<span class="whitespace"> </span>celery
</pre>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">start-airflow</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_start-airflow.svg"><object data="./images/breeze/output_start-airflow.svg" style="width: 100%;" type="image/svg+xml">Breeze start-airflow</object></a>
</div>
<div class="section" id="launching-multiple-terminals-in-the-same-environment">
<h2><a class="toc-backref" href="#id34">Launching multiple terminals in the same environment</a></h2>
<p>Often if you want to run full airflow in the Breeze environment you need to launch multiple terminals and
run <tt class="docutils literal">airflow webserver</tt>, <tt class="docutils literal">airflow scheduler</tt>, <tt class="docutils literal">airflow worker</tt> in separate terminals.</p>
<p>This can be achieved either via <tt class="docutils literal">tmux</tt> or via exec-ing into the running container from the host. Tmux
is installed inside the container and you can launch it with <tt class="docutils literal">tmux</tt> command. Tmux provides you with the
capability of creating multiple virtual terminals and multiplex between them. More about <tt class="docutils literal">tmux</tt> can be
found at <a class="reference external" href="https://github.com/tmux/tmux/wiki">tmux GitHub wiki page</a> . Tmux has several useful shortcuts
that allow you to split the terminals, open new tabs etc - it's pretty useful to learn it.</p>
<p>Another way is to exec into Breeze terminal from the host's terminal. Often you can
have multiple terminals in the host (Linux/MacOS/WSL2 on Windows) and you can simply use those terminals
to enter the running container. It's as easy as launching <tt class="docutils literal">breeze exec</tt> while you already started the
Breeze environment. You will be dropped into bash and environment variables will be read in the same
way as when you enter the environment. You can do it multiple times and open as many terminals as you need.</p>
<p>These are all available flags of <tt class="docutils literal">exec</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_exec.svg"><object data="./images/breeze/output_exec.svg" style="width: 100%;" type="image/svg+xml">Breeze exec</object></a>
</div>
<div class="section" id="compiling-www-assets">
<h2><a class="toc-backref" href="#id35">Compiling www assets</a></h2>
<p>Airflow webserver needs to prepare www assets - compiled with node and yarn. The <tt class="docutils literal"><span class="pre">compile-www-assets</span></tt>
command takes care about it. This is needed when you want to run webserver inside of the breeze.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_compile-www-assets.svg"><object data="./images/breeze/output_compile-www-assets.svg" style="width: 100%;" type="image/svg+xml">Breeze compile-www-assets</object></a>
</div>
<div class="section" id="breeze-cleanup">
<h2><a class="toc-backref" href="#id36">Breeze cleanup</a></h2>
<p>Sometimes you need to cleanup your docker environment (and it is recommended you do that regularly). There
are several reasons why you might want to do that.</p>
<p>Breeze uses docker images heavily and those images are rebuild periodically and might leave dangling, unused
images in docker cache. This might cause extra disk usage. Also running various docker compose commands
(for example running tests with <tt class="docutils literal">breeze testing tests</tt>) might create additional docker networks that might
prevent new networks from being created. Those networks are not removed automatically by docker-compose.
Also Breeze uses it's own cache to keep information about all images.</p>
<p>All those unused images, networks and cache can be removed by running <tt class="docutils literal">breeze cleanup</tt> command. By default
it will not remove the most recent images that you might need to run breeze commands, but you
can also remove those breeze images to clean-up everything by adding <tt class="docutils literal"><span class="pre">--all</span></tt> command (note that you will
need to build the images again from scratch - pulling from the registry might take a while).</p>
<p>Breeze will ask you to confirm each step, unless you specify <tt class="docutils literal"><span class="pre">--answer</span> yes</tt> flag.</p>
<p>These are all available flags of <tt class="docutils literal">cleanup</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_cleanup.svg"><object data="./images/breeze/output_cleanup.svg" style="width: 100%;" type="image/svg+xml">Breeze cleanup</object></a>
</div>
<div class="section" id="running-arbitrary-commands-in-container">
<h2><a class="toc-backref" href="#id37">Running arbitrary commands in container</a></h2>
<p>More sophisticated usages of the breeze shell is using the <tt class="docutils literal">breeze shell</tt> command - it has more parameters
and you can also use it to execute arbitrary commands inside the container.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>shell<span class="whitespace"> </span><span class="literal string double">&quot;ls -la&quot;</span>
</pre>
<p>Those are all available flags of <tt class="docutils literal">shell</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_shell.svg"><object data="./images/breeze/output_shell.svg" style="width: 100%;" type="image/svg+xml">Breeze shell</object></a>
</div>
<div class="section" id="running-breeze-with-metrics">
<h2><a class="toc-backref" href="#id38">Running Breeze with Metrics</a></h2>
<div class="section" id="running-breeze-with-a-statsd-metrics-stack">
<h3><a class="toc-backref" href="#id39">Running Breeze with a StatsD Metrics Stack</a></h3>
<p>You can launch an instance of Breeze pre-configured to emit StatsD metrics using
<tt class="docutils literal">breeze <span class="pre">start-airflow</span> <span class="pre">--integration</span> statsd</tt>.  This will launch an Airflow webserver
within the Breeze environment as well as containers running StatsD, Prometheus, and
Grafana.  The integration configures the &quot;Targets&quot; in Prometheus, the &quot;Datasources&quot; in
Grafana, and includes a default dashboard in Grafana.</p>
<p>When you run Airflow Breeze with this integration, in addition to the standard ports
(See &quot;Port Forwarding&quot; below), the following are also automatically forwarded:</p>
<ul class="simple">
<li>29102 -&gt; forwarded to StatsD Exporter -&gt; breeze-statsd-exporter:9102</li>
<li>29090 -&gt; forwarded to Prometheus -&gt; breeze-prometheus:9090</li>
<li>23000 -&gt; forwarded to Grafana -&gt; breeze-grafana:3000</li>
</ul>
<p>You can connect to these ports/databases using:</p>
<ul class="simple">
<li>StatsD Metrics: <a class="reference external" href="http://127.0.0.1:29102/metrics">http://127.0.0.1:29102/metrics</a></li>
<li>Prometheus Targets: <a class="reference external" href="http://127.0.0.1:29090/targets">http://127.0.0.1:29090/targets</a></li>
<li>Grafana Dashboards: <a class="reference external" href="http://127.0.0.1:23000/dashboards">http://127.0.0.1:23000/dashboards</a></li>
</ul>
</div>
<div class="section" id="running-breeze-with-an-opentelemetry-metrics-stack">
<h3><a class="toc-backref" href="#id40">Running Breeze with an OpenTelemetry Metrics Stack</a></h3>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">BREEZE.rst</tt>, line 776)</p>
Document or section may not begin with a transition.</div>
<hr class="docutils" />
<p>[Work in Progress]
NOTE:  This will launch the stack as described below but Airflow integration is
still a Work in Progress.  This should be considered experimental and likely to
change by the time Airflow fully supports emitting metrics via OpenTelemetry.</p>
<hr class="docutils" />
<p>You can launch an instance of Breeze pre-configured to emit OpenTelemetry metrics
using <tt class="docutils literal">breeze <span class="pre">start-airflow</span> <span class="pre">--integration</span> otel</tt>.  This will launch Airflow within
the Breeze environment as well as containers running OpenTelemetry-Collector,
Prometheus, and Grafana.  The integration handles all configuration of the
&quot;Targets&quot; in Prometheus and the &quot;Datasources&quot; in Grafana, so it is ready to use.</p>
<p>When you run Airflow Breeze with this integration, in addition to the standard ports
(See &quot;Port Forwarding&quot; below), the following are also automatically forwarded:</p>
<ul class="simple">
<li>28889 -&gt; forwarded to OpenTelemetry Collector -&gt; breeze-otel-collector:8889</li>
<li>29090 -&gt; forwarded to Prometheus -&gt; breeze-prometheus:9090</li>
<li>23000 -&gt; forwarded to Grafana -&gt; breeze-grafana:3000</li>
</ul>
<p>You can connect to these ports using:</p>
<ul class="simple">
<li>OpenTelemetry Collector: <a class="reference external" href="http://127.0.0.1:28889/metrics">http://127.0.0.1:28889/metrics</a></li>
<li>Prometheus Targets: <a class="reference external" href="http://127.0.0.1:29090/targets">http://127.0.0.1:29090/targets</a></li>
<li>Grafana Dashboards: <a class="reference external" href="http://127.0.0.1:23000/dashboards">http://127.0.0.1:23000/dashboards</a></li>
</ul>
</div>
<div class="section" id="running-breeze-with-openlineage">
<h3><a class="toc-backref" href="#id41">Running Breeze with OpenLineage</a></h3>
<p>You can launch an instance of Breeze pre-configured to emit OpenLineage metrics using
<tt class="docutils literal">breeze <span class="pre">start-airflow</span> <span class="pre">--integration</span> openlineage</tt>.  This will launch an Airflow webserver
within the Breeze environment as well as containers running a [Marquez](<a class="reference external" href="https://marquezproject.ai/">https://marquezproject.ai/</a>)
webserver and API server.</p>
<p>When you run Airflow Breeze with this integration, in addition to the standard ports
(See &quot;Port Forwarding&quot; below), the following are also automatically forwarded:</p>
<ul class="simple">
<li>MARQUEZ_API_HOST_PORT (default 25000) -&gt; forwarded to Marquez API -&gt; marquez:5000</li>
<li>MARQUEZ_API_ADMIN_HOST_PORT (default 25001) -&gt; forwarded to Marquez Admin API -&gt; marquez:5001</li>
<li>MARQUEZ_HOST_PORT (default 23100) -&gt; forwarded to Marquez -&gt; marquez_web:3000</li>
</ul>
<p>You can connect to these services using:</p>
<ul class="simple">
<li>Marquez Webserver: <a class="reference external" href="http://127.0.0.1:23100">http://127.0.0.1:23100</a></li>
<li>Marquez API: <a class="reference external" href="http://127.0.0.1:25000/api/v1">http://127.0.0.1:25000/api/v1</a></li>
<li>Marquez Admin API: <a class="reference external" href="http://127.0.0.1:25001">http://127.0.0.1:25001</a></li>
</ul>
<p>Make sure to substitute the port numbers if you have customized them via the above env vars.</p>
</div>
</div>
<div class="section" id="stopping-the-environment">
<h2><a class="toc-backref" href="#id42">Stopping the environment</a></h2>
<p>After starting up, the environment runs in the background and takes quite some memory which you might
want to free for other things you are running on your host.</p>
<p>You can always stop it via:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>down
</pre>
<p>These are all available flags of <tt class="docutils literal">down</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_down.svg"><object data="./images/breeze/output_down.svg" style="width: 100%;" type="image/svg+xml">Breeze down</object></a>
</div>
</div>
<div class="section" id="troubleshooting">
<h1><a class="toc-backref" href="#id43">Troubleshooting</a></h1>
<p>If you are having problems with the Breeze environment, try the steps below. After each step you
can check whether your problem is fixed.</p>
<ol class="arabic simple">
<li>If you are on macOS, check if you have enough disk space for Docker (Breeze will warn you if not).</li>
<li>Stop Breeze with <tt class="docutils literal">breeze down</tt>.</li>
<li>Git fetch the origin and git rebase the current branch with main branch.</li>
<li>Delete the <tt class="docutils literal">.build</tt> directory and run <tt class="docutils literal">breeze <span class="pre">ci-image</span> build</tt>.</li>
<li>Clean up Docker images via <tt class="docutils literal">breeze cleanup</tt> command.</li>
<li>Restart your Docker Engine and try again.</li>
<li>Restart your machine and try again.</li>
<li>Re-install Docker Desktop and try again.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If the pip is taking a significant amount of time and your internet connection is causing pip to be unable to download the libraries within the default timeout, it is advisable to modify the default timeout as follows and run the breeze again.</p>
<pre class="code last literal-block">
export PIP_DEFAULT_TIMEOUT=1000
</pre>
</div>
<p>In case the problems are not solved, you can set the VERBOSE_COMMANDS variable to &quot;true&quot;:</p>
<pre class="code literal-block">
export VERBOSE_COMMANDS=&quot;true&quot;
</pre>
<p>Then run the failed command, copy-and-paste the output from your terminal to the
<a class="reference external" href="https://s.apache.org/airflow-slack">Airflow Slack</a>  #airflow-breeze channel and
describe your problem.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Some operating systems (Fedora, ArchLinux, RHEL, Rocky) have recently introduced Kernel changes that result in
Airflow in Breeze consuming 100% memory when run inside the community Docker implementation maintained
by the OS teams.</p>
<p>This is an issue with backwards-incompatible containerd configuration that some of Airflow dependencies
have problems with and is tracked in a few issues:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/moby/moby/issues/43361">Moby issue</a></li>
<li><a class="reference external" href="https://github.com/containerd/containerd/pull/7566">Containerd issue</a></li>
</ul>
<p class="last">There is no solution yet from the containerd team, but seems that installing
<a class="reference external" href="https://docs.docker.com/desktop/install/linux-install/">Docker Desktop on Linux</a> solves the problem as
stated in <a class="reference external" href="https://github.com/moby/moby/issues/43361#issuecomment-1227617516">This comment</a> and allows to
run Breeze with no problems.</p>
</div>
<div class="section" id="etimeout-error">
<h2><a class="toc-backref" href="#id44">ETIMEOUT Error</a></h2>
<p>When running <tt class="docutils literal">breeze <span class="pre">start-airflow</span></tt>, the following output might be observed:</p>
<pre class="code bash literal-block">
Skip<span class="whitespace"> </span>fixing<span class="whitespace"> </span>ownership<span class="whitespace"> </span>of<span class="whitespace"> </span>generated<span class="whitespace"> </span>files<span class="whitespace"> </span>as<span class="whitespace"> </span>Host<span class="whitespace"> </span>OS<span class="whitespace"> </span>is<span class="whitespace"> </span>darwin<span class="whitespace">


</span>Waiting<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>asset<span class="whitespace"> </span>compilation<span class="whitespace"> </span>to<span class="whitespace"> </span><span class="name builtin">complete</span><span class="whitespace"> </span><span class="keyword">in</span><span class="whitespace"> </span>the<span class="whitespace"> </span>background.<span class="whitespace">

</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">

</span>The<span class="whitespace"> </span>asset<span class="whitespace"> </span>compilation<span class="whitespace"> </span>is<span class="whitespace"> </span>taking<span class="whitespace"> </span>too<span class="whitespace"> </span>long.<span class="whitespace">

</span>If<span class="whitespace"> </span>it<span class="whitespace"> </span>does<span class="whitespace"> </span>not<span class="whitespace"> </span><span class="name builtin">complete</span><span class="whitespace"> </span>soon,<span class="whitespace"> </span>you<span class="whitespace"> </span>might<span class="whitespace"> </span>want<span class="whitespace"> </span>to<span class="whitespace"> </span>stop<span class="whitespace"> </span>it<span class="whitespace"> </span>and<span class="whitespace"> </span>remove<span class="whitespace"> </span>file<span class="whitespace"> </span>lock:<span class="whitespace">
  </span>*<span class="whitespace"> </span>press<span class="whitespace"> </span>Ctrl-C<span class="whitespace">
  </span>*<span class="whitespace"> </span>run<span class="whitespace"> </span><span class="literal string single">'rm /opt/airflow/.build/www/.asset_compile.lock'</span><span class="whitespace">

</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">
</span>Still<span class="whitespace"> </span>waiting<span class="whitespace"> </span>.....<span class="whitespace">

</span>The<span class="whitespace"> </span>asset<span class="whitespace"> </span>compilation<span class="whitespace"> </span>failed.<span class="whitespace"> </span>Exiting.<span class="whitespace">

</span><span class="operator">[</span>INFO<span class="operator">]</span><span class="whitespace"> </span>Locking<span class="whitespace"> </span>pre-commit<span class="whitespace"> </span>directory<span class="whitespace">

</span>Error<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>returned
</pre>
<p>This timeout can be increased by setting <tt class="docutils literal">ASSET_COMPILATION_WAIT_MULTIPLIER</tt> a reasonable number
could be 3-4.</p>
<pre class="code bash literal-block">
<span class="name builtin">export</span><span class="whitespace"> </span><span class="name variable">ASSET_COMPILATION_WAIT_MULTIPLIER</span><span class="operator">=</span><span class="literal number">3</span>
</pre>
<p>This error is actually caused by the following error during the asset compilation which resulted in
ETIMEOUT when <tt class="docutils literal">npm</tt> command is trying to install required packages:</p>
<pre class="code bash literal-block">
npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>code<span class="whitespace"> </span>ETIMEDOUT<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>syscall<span class="whitespace"> </span>connect<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>errno<span class="whitespace"> </span>ETIMEDOUT<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>network<span class="whitespace"> </span>request<span class="whitespace"> </span>to<span class="whitespace"> </span>https://registry.npmjs.org/yarn<span class="whitespace"> </span>failed,<span class="whitespace"> </span>reason:<span class="whitespace"> </span>connect<span class="whitespace"> </span>ETIMEDOUT<span class="whitespace"> </span><span class="literal number">2606</span>:4700::6810:1723:443<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>network<span class="whitespace"> </span>This<span class="whitespace"> </span>is<span class="whitespace"> </span>a<span class="whitespace"> </span>problem<span class="whitespace"> </span>related<span class="whitespace"> </span>to<span class="whitespace"> </span>network<span class="whitespace"> </span>connectivity.<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>network<span class="whitespace"> </span>In<span class="whitespace"> </span>most<span class="whitespace"> </span>cases<span class="whitespace"> </span>you<span class="whitespace"> </span>are<span class="whitespace"> </span>behind<span class="whitespace"> </span>a<span class="whitespace"> </span>proxy<span class="whitespace"> </span>or<span class="whitespace"> </span>have<span class="whitespace"> </span>bad<span class="whitespace"> </span>network<span class="whitespace"> </span>settings.<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>network<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>network<span class="whitespace"> </span>If<span class="whitespace"> </span>you<span class="whitespace"> </span>are<span class="whitespace"> </span>behind<span class="whitespace"> </span>a<span class="whitespace"> </span>proxy,<span class="whitespace"> </span>please<span class="whitespace"> </span>make<span class="whitespace"> </span>sure<span class="whitespace"> </span>that<span class="whitespace"> </span>the<span class="whitespace">
</span>npm<span class="whitespace"> </span>ERR!<span class="whitespace"> </span>network<span class="whitespace"> </span><span class="literal string single">'proxy'</span><span class="whitespace"> </span>config<span class="whitespace"> </span>is<span class="whitespace"> </span><span class="name builtin">set</span><span class="whitespace"> </span>properly.<span class="whitespace">  </span>See:<span class="whitespace"> </span><span class="literal string single">'npm help config'</span>
</pre>
<p>In this situation, notice that the IP address <tt class="docutils literal"><span class="pre">2606:4700::6810:1723:443</span></tt> is in IPv6 format, which was the
reason why the connection did not go through the router, as the router did not support IPv6 addresses in its DNS lookup.
In this case, disabling IPv6 in the host machine and using IPv4 instead resolved the issue.</p>
<p>The similar issue could happen if you are behind an HTTP/HTTPS proxy and your access to required websites are
blocked by it, or your proxy setting has not been done properly.</p>
</div>
</div>
<div class="section" id="advanced-commands">
<h1><a class="toc-backref" href="#id45">Advanced commands</a></h1>
<p>Airflow Breeze is a Python script serving as a &quot;swiss-army-knife&quot; of Airflow testing. Under the
hood it uses other scripts that you can also run manually if you have problem with running the Breeze
environment. Breeze script allows performing the following tasks:</p>
<div class="section" id="running-tests">
<h2><a class="toc-backref" href="#id46">Running tests</a></h2>
<p>You can run tests with <tt class="docutils literal">breeze</tt>. There are various tests type and breeze allows to run different test
types easily. You can run unit tests in different ways, either interactively run tests with the default
<tt class="docutils literal">shell</tt> command or via the <tt class="docutils literal">testing</tt> commands. The latter allows to run more kinds of tests easily.</p>
<p>Here is the detailed set of options for the <tt class="docutils literal">breeze testing</tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_testing.svg"><object data="./images/breeze/output_testing.svg" style="width: 100%;" type="image/svg+xml">Breeze testing</object></a>
<div class="section" id="iterate-on-tests-interactively-via-shell-command">
<h3><a class="toc-backref" href="#id47">Iterate on tests interactively via <tt class="docutils literal">shell</tt> command</a></h3>
<p>You can simply enter the <tt class="docutils literal">breeze</tt> container in interactive shell (via <tt class="docutils literal">breeze</tt> or more comprehensive
<tt class="docutils literal">breeze shell</tt> command) or use your local virtualenv and run <tt class="docutils literal">pytest</tt> command there.
This is the best way if you want to interactively run selected tests and iterate with the tests.</p>
<p>The good thing about <tt class="docutils literal">breeze</tt> interactive shell is that it has all the dependencies to run all the tests
and it has the running and configured backed database started for you when you decide to run DB tests.
It also has auto-complete enabled for <tt class="docutils literal">pytest</tt> command so that you can easily run the tests you want.
(autocomplete should help you with autocompleting test name if you start typing <tt class="docutils literal">pytest tests&lt;TAB&gt;</tt>).</p>
<p>Here are few examples:</p>
<p>Running single test:</p>
<pre class="code bash literal-block">
pytest<span class="whitespace"> </span>tests/core/test_core.py::TestCore::test_dag_params_and_task_params
</pre>
<p>To run the whole test class:</p>
<pre class="code bash literal-block">
pytest<span class="whitespace"> </span>tests/core/test_core.py::TestCore
</pre>
<p>You can re-run the tests interactively, add extra parameters to pytest  and modify the files before
re-running the test to iterate over the tests. You can also add more flags when starting the
<tt class="docutils literal">breeze shell</tt> command when you run integration tests or system tests. Read more details about it
in the <a class="reference external" href="TESTING.rst">testing doc</a> where all the test types and information on how to run them are explained.</p>
<p>This applies to all kind of tests - all our tests can be run using pytest.</p>
</div>
<div class="section" id="running-unit-tests-with-breeze-testing-commands">
<h3><a class="toc-backref" href="#id48">Running unit tests with <tt class="docutils literal">breeze testing</tt> commands</a></h3>
<p>An option you have is that you can also run tests via built-in <tt class="docutils literal">breeze testing tests</tt> command - which
is a &quot;swiss-army-knife&quot; of unit testing with Breeze. This command has a lot of parameters and is very
flexible thus might be a bit overwhelming.</p>
<p>In most cases if you want to run tess you want to use dedicated <tt class="docutils literal">breeze testing <span class="pre">db-tests</span></tt>
or <tt class="docutils literal">breeze testing <span class="pre">non-db-tests</span></tt> commands that automatically run groups of tests that allow you to choose
subset of tests to run (with <tt class="docutils literal"><span class="pre">--parallel-test-types</span></tt> flag)</p>
</div>
<div class="section" id="using-breeze-testing-tests-command">
<h3><a class="toc-backref" href="#id49">Using <tt class="docutils literal">breeze testing tests</tt> command</a></h3>
<p>The <tt class="docutils literal">breeze testing tests</tt> command is that you can easily specify sub-set of the tests -- including
selecting specific Providers tests to run.</p>
<p>For example this will only run provider tests for airbyte and http providers:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>tests<span class="whitespace"> </span>--test-type<span class="whitespace"> </span><span class="literal string double">&quot;Providers[airbyte,http]&quot;</span>
</pre>
<p>You can also exclude tests for some providers from being run when whole &quot;Providers&quot; test type is run.</p>
<p>For example this will run tests for all providers except amazon and google provider tests:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>tests<span class="whitespace"> </span>--test-type<span class="whitespace"> </span><span class="literal string double">&quot;Providers[-amazon,google]&quot;</span>
</pre>
<p>You can also run parallel tests with <tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> flag - by default it will run all tests types
in parallel, but you can specify the test type that you want to run with space separated list of test
types passed to <tt class="docutils literal"><span class="pre">--parallel-test-types</span></tt> flag.</p>
<p>For example this will run API and WWW tests in parallel:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>tests<span class="whitespace"> </span>--parallel-test-types<span class="whitespace"> </span><span class="literal string double">&quot;API WWW&quot;</span><span class="whitespace"> </span>--run-in-parallel
</pre>
<p>There are few special types of tests that you can run:</p>
<ul class="simple">
<li><tt class="docutils literal">All</tt> - all tests are run in single pytest run.</li>
<li><tt class="docutils literal"><span class="pre">All-Postgres</span></tt> - runs all tests that require Postgres database</li>
<li><tt class="docutils literal"><span class="pre">All-MySQL</span></tt> - runs all tests that require MySQL database</li>
<li><tt class="docutils literal"><span class="pre">All-Quarantine</span></tt> - runs all tests that are in quarantine (marked with <tt class="docutils literal">&#64;pytest.mark.quarantined</tt>
decorator)</li>
</ul>
<p>Here is the detailed set of options for the <tt class="docutils literal">breeze testing tests</tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_testing_tests.svg"><object data="./images/breeze/output_testing_tests.svg" style="width: 100%;" type="image/svg+xml">Breeze testing tests</object></a>
</div>
<div class="section" id="using-breeze-testing-db-tests-command">
<h3><a class="toc-backref" href="#id50">Using <tt class="docutils literal">breeze testing <span class="pre">db-tests</span></tt> command</a></h3>
<p>The <tt class="docutils literal">breeze testing <span class="pre">db-tests</span></tt> command is simplified version of the <tt class="docutils literal">breeze testing tests</tt> command
that only allows you to run tests that are not bound to a database - in parallel utilising all your CPUS.
The DB-bound tests are the ones that require a database to be started and configured separately for
each test type run and they are run in parallel containers/parallel docker compose projects to
utilise multiple CPUs your machine has - thus allowing you to quickly run few groups of tests in parallel.
This command is used in CI to run DB tests.</p>
<p>By default this command will run complete set of test types we have, thus allowing you to see result
of all DB tests we have but you can choose a subset of test types to run by <tt class="docutils literal"><span class="pre">--parallel-test-types</span></tt>
flag or exclude some test types by specifying <tt class="docutils literal"><span class="pre">--excluded-parallel-test-types</span></tt> flag.</p>
<p>Run all DB tests:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>db-tests
</pre>
<p>Only run DB tests from &quot;API CLI WWW&quot; test types:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>db-tests<span class="whitespace"> </span>--parallel-test-types<span class="whitespace"> </span><span class="literal string double">&quot;API CLI WWW&quot;</span>
</pre>
<p>Run all DB tests excluding those in CLI and WWW test types:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>db-tests<span class="whitespace"> </span>--excluded-parallel-test-types<span class="whitespace"> </span><span class="literal string double">&quot;CLI WWW&quot;</span>
</pre>
<p>Here is the detailed set of options for the <tt class="docutils literal">breeze testing <span class="pre">db-tests</span></tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_testing_db-tests.svg"><object data="./images/breeze/output_testing_db-tests.svg" style="width: 100%;" type="image/svg+xml">Breeze testing db-tests</object></a>
</div>
<div class="section" id="using-breeze-testing-non-db-tests-command">
<h3><a class="toc-backref" href="#id51">Using <tt class="docutils literal">breeze testing <span class="pre">non-db-tests</span></tt> command</a></h3>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">BREEZE.rst</tt>, line 1119)</p>
<p>Title underline too short.</p>
<pre class="literal-block">
Using ``breeze testing non-db-tests`` command
.........................................
</pre>
</div>
<p>The <tt class="docutils literal">breeze testing <span class="pre">non-db-tests</span></tt> command is simplified version of the <tt class="docutils literal">breeze testing tests</tt> command
that only allows you to run tests that are not bound to a database - in parallel utilising all your CPUS.
The non-DB-bound tests are the ones that do not expect a database to be started and configured and we can
utilise multiple CPUs your machine has via <tt class="docutils literal"><span class="pre">pytest-xdist</span></tt> plugin - thus allowing you to quickly
run few groups of tests in parallel using single container rather than many of them as it is the case for
DB-bound tests. This command is used in CI to run Non-DB tests.</p>
<p>By default this command will run complete set of test types we have, thus allowing you to see result
of all DB tests we have but you can choose a subset of test types to run by <tt class="docutils literal"><span class="pre">--parallel-test-types</span></tt>
flag or exclude some test types by specifying <tt class="docutils literal"><span class="pre">--excluded-parallel-test-types</span></tt> flag.</p>
<p>Run all non-DB tests:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>non-db-tests
</pre>
<p>Only run non-DB tests from &quot;API CLI WWW&quot; test types:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>non-db-tests<span class="whitespace"> </span>--parallel-test-types<span class="whitespace"> </span><span class="literal string double">&quot;API CLI WWW&quot;</span>
</pre>
<p>Run all non-DB tests excluding those in CLI and WWW test types:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>non-db-tests<span class="whitespace"> </span>--excluded-parallel-test-types<span class="whitespace"> </span><span class="literal string double">&quot;CLI WWW&quot;</span>
</pre>
<p>Here is the detailed set of options for the <tt class="docutils literal">breeze testing <span class="pre">non-db-tests</span></tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_testing_non-db-tests.svg"><object data="./images/breeze/output_testing_non-db-tests.svg" style="width: 100%;" type="image/svg+xml">Breeze testing non-db-tests</object></a>
</div>
<div class="section" id="running-integration-tests">
<h3><a class="toc-backref" href="#id52">Running integration tests</a></h3>
<p>You can also run integration tests via built-in <tt class="docutils literal">breeze testing <span class="pre">integration-tests</span></tt> command. Some of our
tests require additional integrations to be started in docker-compose. The integration tests command will
run the expected integration and tests that need that integration.</p>
<p>For example this will only run kerberos tests:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>testing<span class="whitespace"> </span>integration-tests<span class="whitespace"> </span>--integration<span class="whitespace"> </span>kerberos
</pre>
<p>Here is the detailed set of options for the <tt class="docutils literal">breeze testing <span class="pre">integration-tests</span></tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_testing_integration_tests.svg"><object data="./images/breeze/output_testing_integration-tests.svg" style="width: 100%;" type="image/svg+xml">Breeze testing integration-tests</object></a>
</div>
<div class="section" id="running-helm-unit-tests">
<h3><a class="toc-backref" href="#id53">Running Helm unit tests</a></h3>
<p>You can use Breeze to run all Helm unit tests. Those tests are run inside the breeze image as there are all
necessary tools installed there. Those tests are merely checking if the Helm chart of ours renders properly
as expected when given a set of configuration parameters. The tests can be run in parallel if you have
multiple CPUs by specifying <tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> flag - in which case they will run separate containers
(one per helm-test package) and they will run in parallel.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_testing_helm-tests.svg"><object data="./images/breeze/output_testing_helm-tests.svg" style="width: 100%;" type="image/svg+xml">Breeze testing helm-tests</object></a>
<p>You can also iterate over those tests with pytest commands, similarly as in case of regular unit tests.
The helm tests can be found in <tt class="docutils literal">tests/chart</tt> folder in the main repo.</p>
</div>
<div class="section" id="running-docker-compose-tests">
<h3><a class="toc-backref" href="#id54">Running docker-compose tests</a></h3>
<p>You can use Breeze to run all docker-compose tests. Those tests are run using Production image
and they are running test with the Quick-start docker compose we have.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_testing_docker-compose-tests.svg"><object data="./images/breeze/output_testing_docker-compose-tests.svg" style="width: 100%;" type="image/svg+xml">Breeze testing docker-compose-tests</object></a>
<p>You can also iterate over those tests with pytest command, but - unlike regular unit tests and
Helm tests, they need to be run in local virtual environment. They also require to have
<tt class="docutils literal">DOCKER_IMAGE</tt> environment variable set, pointing to the image to test if you do not run them
through <tt class="docutils literal">breeze testing <span class="pre">docker-compose-tests</span></tt> command.</p>
<p>The docker-compose tests are in <tt class="docutils literal"><span class="pre">docker-tests/</span></tt> folder in the main repo.</p>
</div>
</div>
<div class="section" id="running-kubernetes-tests">
<h2><a class="toc-backref" href="#id55">Running Kubernetes tests</a></h2>
<p>Breeze helps with running Kubernetes tests in the same environment/way as CI tests are run.
Breeze helps to setup KinD cluster for testing, setting up virtualenv and downloads the right tools
automatically to run the tests.</p>
<p>You can:</p>
<ul class="simple">
<li>Setup environment for k8s tests with <tt class="docutils literal">breeze k8s <span class="pre">setup-env</span></tt></li>
<li>Build airflow k8S images with <tt class="docutils literal">breeze k8s <span class="pre">build-k8s-image</span></tt></li>
<li>Manage KinD Kubernetes cluster and upload image and deploy Airflow to KinD cluster via
<tt class="docutils literal">breeze k8s <span class="pre">create-cluster</span></tt>, <tt class="docutils literal">breeze k8s <span class="pre">configure-cluster</span></tt>, <tt class="docutils literal">breeze k8s <span class="pre">deploy-airflow</span></tt>, <tt class="docutils literal">breeze k8s status</tt>,
<tt class="docutils literal">breeze k8s <span class="pre">upload-k8s-image</span></tt>, <tt class="docutils literal">breeze k8s <span class="pre">delete-cluster</span></tt> commands</li>
<li>Run Kubernetes tests  specified with <tt class="docutils literal">breeze k8s tests</tt> command</li>
<li>Run complete test run with <tt class="docutils literal">breeze k8s <span class="pre">run-complete-tests</span></tt> - performing the full cycle of creating
cluster, uploading the image, deploying airflow, running tests and deleting the cluster</li>
<li>Enter the interactive kubernetes test environment with <tt class="docutils literal">breeze k8s shell</tt> and <tt class="docutils literal">breeze k8s k9s</tt> command</li>
<li>Run multi-cluster-operations <tt class="docutils literal">breeze k8s <span class="pre">list-all-clusters</span></tt> and
<tt class="docutils literal">breeze k8s <span class="pre">delete-all-clusters</span></tt> commands as well as running complete tests in parallel
via <tt class="docutils literal">breeze k8s <span class="pre">dump-logs</span></tt> command</li>
</ul>
<p>This is described in detail in <a class="reference external" href="TESTING.rst#running-tests-with-kubernetes">Testing Kubernetes</a>.</p>
<p>You can read more about KinD that we use in <a class="reference external" href="https://kind.sigs.k8s.io/">The documentation</a></p>
<p>Here is the detailed set of options for the <tt class="docutils literal">breeze k8s</tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s.svg"><object data="./images/breeze/output_k8s.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s</object></a>
<div class="section" id="setting-up-k8s-environment">
<h3><a class="toc-backref" href="#id56">Setting up K8S environment</a></h3>
<p>Kubernetes environment can be set with the <tt class="docutils literal">breeze k8s <span class="pre">setup-env</span></tt> command.
It will create appropriate virtualenv to run tests and download the right set of tools to run
the tests: <tt class="docutils literal">kind</tt>, <tt class="docutils literal">kubectl</tt> and <tt class="docutils literal">helm</tt> in the right versions. You can re-run the command
when you want to make sure the expected versions of the tools are installed properly in the
virtualenv. The Virtualenv is available in <tt class="docutils literal"><span class="pre">.build/.k8s-env/bin</span></tt> subdirectory of your Airflow
installation.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_setup-env.svg"><object data="./images/breeze/output_k8s_setup-env.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s setup-env</object></a>
</div>
<div class="section" id="creating-k8s-cluster">
<h3><a class="toc-backref" href="#id57">Creating K8S cluster</a></h3>
<p>You can create kubernetes cluster (separate cluster for each python/kubernetes version) via
<tt class="docutils literal">breeze k8s <span class="pre">create-cluster</span></tt> command. With <tt class="docutils literal"><span class="pre">--force</span></tt> flag the cluster will be
deleted if exists. You can also use it to create multiple clusters in parallel with
<tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> flag - this is what happens in our CI.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_create-cluster.svg"><object data="./images/breeze/output_k8s_create-cluster.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s create-cluster</object></a>
</div>
<div class="section" id="deleting-k8s-cluster">
<h3><a class="toc-backref" href="#id58">Deleting K8S cluster</a></h3>
<p>You can delete current kubernetes cluster via <tt class="docutils literal">breeze k8s <span class="pre">delete-cluster</span></tt> command. You can also add
<tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> flag to delete all clusters.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_delete-cluster.svg"><object data="./images/breeze/output_k8s_delete-cluster.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s delete-cluster</object></a>
</div>
<div class="section" id="building-airflow-k8s-images">
<h3><a class="toc-backref" href="#id59">Building Airflow K8s images</a></h3>
<p>Before deploying Airflow Helm Chart, you need to make sure the appropriate Airflow image is build (it has
embedded test dags, pod templates and webserver is configured to refresh immediately. This can
be done via <tt class="docutils literal">breeze k8s <span class="pre">build-k8s-image</span></tt> command. It can also be done in parallel for all images via
<tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> flag.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_build-k8s-image.svg"><object data="./images/breeze/output_k8s_build-k8s-image.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s build-k8s-image</object></a>
</div>
<div class="section" id="uploading-airflow-k8s-images">
<h3><a class="toc-backref" href="#id60">Uploading Airflow K8s images</a></h3>
<p>The K8S airflow images need to be uploaded to the KinD cluster. This can be done via
<tt class="docutils literal">breeze k8s <span class="pre">upload-k8s-image</span></tt> command. It can also be done in parallel for all images via
<tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> flag.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_upload-k8s-image.svg"><object data="./images/breeze/output_k8s_upload-k8s-image.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s upload-k8s-image</object></a>
</div>
<div class="section" id="configuring-k8s-cluster">
<h3><a class="toc-backref" href="#id61">Configuring K8S cluster</a></h3>
<p>In order to deploy Airflow, the cluster needs to be configured. Airflow namespace needs to be created
and test resources should be deployed. By passing <tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> the configuration can be run
for all clusters in parallel.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_configure-cluster.svg"><object data="./images/breeze/output_k8s_configure-cluster.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s configure-cluster</object></a>
</div>
<div class="section" id="deploying-airflow-to-the-cluster">
<h3><a class="toc-backref" href="#id62">Deploying Airflow to the Cluster</a></h3>
<p>Airflow can be deployed to the Cluster with <tt class="docutils literal">breeze k8s <span class="pre">deploy-airflow</span></tt>. This step will automatically
(unless disabled by switches) will rebuild the image to be deployed. It also uses the latest version
of the Airflow Helm Chart to deploy it. You can also choose to upgrade existing airflow deployment
and pass extra arguments to <tt class="docutils literal">helm install</tt> or <tt class="docutils literal">helm upgrade</tt> commands that are used to
deploy airflow. By passing <tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> the deployment can be run
for all clusters in parallel.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_deploy-airflow.svg"><object data="./images/breeze/output_k8s_deploy-airflow.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s deploy-airflow</object></a>
</div>
<div class="section" id="checking-status-of-the-k8s-cluster">
<h3><a class="toc-backref" href="#id63">Checking status of the K8S cluster</a></h3>
<p>You can delete kubernetes cluster and airflow deployed in the current cluster
via <tt class="docutils literal">breeze k8s status</tt> command. It can be also checked for all clusters created so far by passing
<tt class="docutils literal"><span class="pre">--all</span></tt> flag.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_status.svg"><object data="./images/breeze/output_k8s_status.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s status</object></a>
</div>
<div class="section" id="running-k8s-tests">
<h3><a class="toc-backref" href="#id64">Running k8s tests</a></h3>
<p>You can run <tt class="docutils literal">breeze k8s tests</tt> command to run <tt class="docutils literal">pytest</tt> tests with your cluster. Those tests are placed
in <tt class="docutils literal">kubernetes_tests/</tt> and you can either specify the tests to run as parameter of the tests command or
you can leave them empty to run all tests. By passing <tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> the tests can be run
for all clusters in parallel.</p>
<p>Run all tests:</p>
<!-- code-block::bash

breeze k8s tests -->
<p>Run selected tests:</p>
<!-- code-block::bash

breeze k8s tests test_kubernetes_executor.py -->
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_tests.svg"><object data="./images/breeze/output_k8s_tests.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s tests</object></a>
<p>You can also specify any pytest flags as extra parameters - they will be passed to the
shell command directly. In case the shell parameters are the same as the parameters of the command, you
can pass them after <tt class="docutils literal"><span class="pre">--</span></tt>. For example this is the way how you can see all available parameters of the shell
you have:</p>
<!-- code-block::bash

breeze k8s tests - - - -help -->
<p>The options that are not overlapping with the <tt class="docutils literal">tests</tt> command options can be passed directly and mixed
with the specifications of tests you want to run. For example the command below will only run
<tt class="docutils literal">test_kubernetes_executor.py</tt> and will suppress capturing output from Pytest so that you can see the
output during test execution.</p>
<!-- code-block::bash

breeze k8s tests - - test_kubernetes_executor.py -s -->
</div>
<div class="section" id="running-k8s-complete-tests">
<h3><a class="toc-backref" href="#id65">Running k8s complete tests</a></h3>
<p>You can run <tt class="docutils literal">breeze k8s <span class="pre">run-complete-tests</span></tt> command to combine all previous steps in one command. That
command will create cluster, deploy airflow and run tests and finally delete cluster. It is used in CI
to run the whole chains in parallel.</p>
<p>Run all tests:</p>
<!-- code-block::bash

breeze k8s run-complete-tests -->
<p>Run selected tests:</p>
<!-- code-block::bash

breeze k8s run-complete-tests test_kubernetes_executor.py -->
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_run-complete-tests.svg"><object data="./images/breeze/output_k8s_run-complete-tests.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s tests</object></a>
<p>You can also specify any pytest flags as extra parameters - they will be passed to the
shell command directly. In case the shell parameters are the same as the parameters of the command, you
can pass them after <tt class="docutils literal"><span class="pre">--</span></tt>. For example this is the way how you can see all available parameters of the shell
you have:</p>
<!-- code-block::bash

breeze k8s run-complete-tests - - - -help -->
<p>The options that are not overlapping with the <tt class="docutils literal">tests</tt> command options can be passed directly and mixed
with the specifications of tests you want to run. For example the command below will only run
<tt class="docutils literal">test_kubernetes_executor.py</tt> and will suppress capturing output from Pytest so that you can see the
output during test execution.</p>
<!-- code-block::bash

breeze k8s run-complete-tests - - test_kubernetes_executor.py -s -->
</div>
<div class="section" id="entering-k8s-shell">
<h3><a class="toc-backref" href="#id66">Entering k8s shell</a></h3>
<p>You can have multiple clusters created - with different versions of Kubernetes and Python at the same time.
Breeze enables you to interact with the chosen cluster by entering dedicated shell session that has the
cluster pre-configured. This is done via <tt class="docutils literal">breeze k8s shell</tt> command.</p>
<p>Once you are in the shell, the prompt will indicate which cluster you are interacting with as well
as executor you use, similar to:</p>
<!-- code-block::bash

(kind-airflow-python-3.9-v1.24.0:KubernetesExecutor)> -->
<p>The shell automatically activates the virtual environment that has all appropriate dependencies
installed and you can interactively run all k8s tests with pytest command (of course the cluster need to
be created and airflow deployed to it before running the tests):</p>
<!-- code-block::bash

(kind-airflow-python-3.9-v1.24.0:KubernetesExecutor)> pytest test_kubernetes_executor.py
================================================= test session starts =================================================
platform linux - - Python 3.10.6, pytest-6.2.5, py-1.11.0, pluggy-1.0.0 - - /home/jarek/code/airflow/.build/.k8s-env/bin/python
cachedir: .pytest_cache
rootdir: /home/jarek/code/airflow, configfile: pytest.ini
plugins: anyio-3.6.1
collected 2 items

test_kubernetes_executor.py::TestKubernetesExecutor::test_integration_run_dag PASSED           [ 50%]
test_kubernetes_executor.py::TestKubernetesExecutor::test_integration_run_dag_with_scheduler_failure PASSED [100%]

================================================== warnings summary ===================================================
.build/.k8s-env/lib/python3.10/site-packages/_pytest/config/__init__.py:1233
  /home/jarek/code/airflow/.build/.k8s-env/lib/python3.10/site-packages/_pytest/config/__init__.py:1233: PytestConfigWarning: Unknown config option: asyncio_mode

    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

- - Docs: https://docs.pytest.org/en/stable/warnings.html
============================================ 2 passed, 1 warning in 38.62s ============================================
(kind-airflow-python-3.9-v1.24.0:KubernetesExecutor)> -->
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_shell.svg"><object data="./images/breeze/output_k8s_shell.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s shell</object></a>
<p>You can also specify any shell flags and commands as extra parameters - they will be passed to the
shell command directly. In case the shell parameters are the same as the parameters of the command, you
can pass them after <tt class="docutils literal"><span class="pre">--</span></tt>. For example this is the way how you can see all available parameters of the shell
you have:</p>
<!-- code-block::bash

breeze k8s shell - - - -help -->
</div>
<div class="section" id="running-k9s-tool">
<h3><a class="toc-backref" href="#id67">Running k9s tool</a></h3>
<p>The <tt class="docutils literal">k9s</tt> is a fantastic tool that allows you to interact with running k8s cluster. Since we can have
multiple clusters capability, <tt class="docutils literal">breeze k8s k9s</tt> allows you to start k9s without setting it up or
downloading - it uses k9s docker image to run it and connect it to the right cluster.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_k9s.svg"><object data="./images/breeze/output_k8s_k9s.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s k9s</object></a>
<p>You can also specify any <tt class="docutils literal">k9s</tt> flags and commands as extra parameters - they will be passed to the
<tt class="docutils literal">k9s</tt> command directly. In case the <tt class="docutils literal">k9s</tt> parameters are the same as the parameters of the command, you
can pass them after <tt class="docutils literal"><span class="pre">--</span></tt>. For example this is the way how you can see all available parameters of the
<tt class="docutils literal">k9s</tt> you have:</p>
<!-- code-block::bash

breeze k8s k9s - - - -help -->
</div>
<div class="section" id="dumping-logs-from-all-k8s-clusters">
<h3><a class="toc-backref" href="#id68">Dumping logs from all k8s clusters</a></h3>
<p>KinD allows to export logs from the running cluster so that you can troubleshoot your deployment.
This can be done with <tt class="docutils literal">breeze k8s logs</tt> command. Logs can be also dumped for all clusters created
so far by passing <tt class="docutils literal"><span class="pre">--all</span></tt> flag.</p>
<p>All parameters of the command are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_k8s_logs.svg"><object data="./images/breeze/output_k8s_logs.svg" style="width: 100%;" type="image/svg+xml">Breeze k8s logs</object></a>
</div>
</div>
<div class="section" id="ci-image-tasks">
<h2><a class="toc-backref" href="#id69">CI Image tasks</a></h2>
<p>The image building is usually run for users automatically when needed,
but sometimes Breeze users might want to manually build, pull or verify the CI images.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci-image.svg"><object data="./images/breeze/output_ci-image.svg" style="width: 100%;" type="image/svg+xml">Breeze ci-image</object></a>
<p>For all development tasks, unit tests, integration tests, and static code checks, we use the
<strong>CI image</strong> maintained in GitHub Container Registry.</p>
<p>The CI image is built automatically as needed, however it can be rebuilt manually with
<tt class="docutils literal">ci image build</tt> command.</p>
<p>Building the image first time pulls a pre-built version of images from the Docker Hub, which may take some
time. But for subsequent source code changes, no wait time is expected.
However, changes to sensitive files like <tt class="docutils literal">pyproject.toml</tt> or <tt class="docutils literal">Dockerfile.ci</tt> will trigger a rebuild
that may take more time though it is highly optimized to only rebuild what is needed.</p>
<p>Breeze has built in mechanism to check if your local image has not diverged too much from the
latest image build on CI. This might happen when for example latest patches have been released as new
Python images or when significant changes are made in the Dockerfile. In such cases, Breeze will
download the latest images before rebuilding because this is usually faster than rebuilding the image.</p>
<div class="section" id="building-ci-image">
<h3><a class="toc-backref" href="#id70">Building CI image</a></h3>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">ci-image</span> build</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci-image_build.svg"><object data="./images/breeze/output_ci-image_build.svg" style="width: 100%;" type="image/svg+xml">Breeze ci-image build</object></a>
</div>
<div class="section" id="pulling-ci-image">
<h3><a class="toc-backref" href="#id71">Pulling CI image</a></h3>
<p>You can also pull the CI images locally in parallel with optional verification.</p>
<p>These are all available flags of <tt class="docutils literal">pull</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci-image_pull.svg"><object data="./images/breeze/output_ci-image_pull.svg" style="width: 100%;" type="image/svg+xml">Breeze ci-image pull</object></a>
</div>
<div class="section" id="verifying-ci-image">
<h3><a class="toc-backref" href="#id72">Verifying CI image</a></h3>
<p>Finally, you can verify CI image by running tests - either with the pulled/built images or
with an arbitrary image.</p>
<p>These are all available flags of <tt class="docutils literal">verify</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci-image_verify.svg"><object data="./images/breeze/output_ci-image_verify.svg" style="width: 100%;" type="image/svg+xml">Breeze ci-image verify</object></a>
</div>
</div>
<div class="section" id="prod-image-tasks">
<h2><a class="toc-backref" href="#id73">PROD Image tasks</a></h2>
<p>Users can also build Production images when they are developing them. However when you want to
use the PROD image, the regular docker build commands are recommended. See
<a class="reference external" href="https://airflow.apache.org/docs/docker-stack/build.html">building the image</a></p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_prod-image.svg"><object data="./images/breeze/output_prod-image.svg" style="width: 100%;" type="image/svg+xml">Breeze prod-image</object></a>
<p>The <strong>Production image</strong> is also maintained in GitHub Container Registry for Caching
and in <tt class="docutils literal">apache/airflow</tt> manually pushed for released versions. This Docker image (built using official
Dockerfile) contains size-optimised Airflow installation with selected extras and dependencies.</p>
<p>However in many cases you want to add your own custom version of the image - with added apt dependencies,
python dependencies, additional Airflow extras. Breeze's <tt class="docutils literal"><span class="pre">prod-image</span> build</tt> command helps to build your own,
customized variant of the image that contains everything you need.</p>
<p>You can building the production image manually by using <tt class="docutils literal"><span class="pre">prod-image</span> build</tt> command.
Note, that the images can also be built using <tt class="docutils literal">docker build</tt> command by passing appropriate
build-args as described in <a class="reference external" href="IMAGES.rst">IMAGES.rst</a> , but Breeze provides several flags that
makes it easier to do it. You can see all the flags by running <tt class="docutils literal">breeze <span class="pre">prod-image</span> build <span class="pre">--help</span></tt>,
but here typical examples are presented:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>prod-image<span class="whitespace"> </span>build<span class="whitespace"> </span>--additional-airflow-extras<span class="whitespace"> </span><span class="literal string double">&quot;jira&quot;</span>
</pre>
<p>This installs additional <tt class="docutils literal">jira</tt> extra while installing airflow in the image.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>prod-image<span class="whitespace"> </span>build<span class="whitespace"> </span>--additional-python-deps<span class="whitespace"> </span><span class="literal string double">&quot;torchio==0.17.10&quot;</span>
</pre>
<p>This install additional pypi dependency - torchio in specified version.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>prod-image<span class="whitespace"> </span>build<span class="whitespace"> </span>--additional-dev-apt-deps<span class="whitespace"> </span><span class="literal string double">&quot;libasound2-dev&quot;</span><span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">    </span>--additional-runtime-apt-deps<span class="whitespace"> </span><span class="literal string double">&quot;libasound2&quot;</span>
</pre>
<p>This installs additional apt dependencies - <tt class="docutils literal"><span class="pre">libasound2-dev</span></tt> in the build image and <tt class="docutils literal">libasound</tt> in the
final image. Those are development dependencies that might be needed to build and use python packages added
via the <tt class="docutils literal"><span class="pre">--additional-python-deps</span></tt> flag. The <tt class="docutils literal">dev</tt> dependencies are not installed in the final
production image, they are only installed in the build &quot;segment&quot; of the production image that is used
as an intermediate step to build the final image. Usually names of the <tt class="docutils literal">dev</tt> dependencies end with <tt class="docutils literal"><span class="pre">-dev</span></tt>
suffix and they need to also be paired with corresponding runtime dependency added for the runtime image
(without -dev).</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>prod-image<span class="whitespace"> </span>build<span class="whitespace"> </span>--python<span class="whitespace"> </span><span class="literal number">3</span>.8<span class="whitespace"> </span>--additional-dev-deps<span class="whitespace"> </span><span class="literal string double">&quot;libasound2-dev&quot;</span><span class="whitespace"> </span><span class="literal string escape">\
</span><span class="whitespace">   </span>--additional-runtime-apt-deps<span class="whitespace"> </span><span class="literal string double">&quot;libasound2&quot;</span>
</pre>
<p>Same as above but uses python 3.8.</p>
<div class="section" id="building-prod-image">
<h3><a class="toc-backref" href="#id74">Building PROD image</a></h3>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">build-prod-image</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_prod-image_build.svg"><object data="./images/breeze/output_prod-image_build.svg" style="width: 100%;" type="image/svg+xml">Breeze prod-image build</object></a>
</div>
<div class="section" id="pulling-prod-image">
<h3><a class="toc-backref" href="#id75">Pulling PROD image</a></h3>
<p>You can also pull PROD images in parallel with optional verification.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">pull-prod-image</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_prod-image_pull.svg"><object data="./images/breeze/output_prod-image_pull.svg" style="width: 100%;" type="image/svg+xml">Breeze prod-image pull</object></a>
</div>
<div class="section" id="verifying-prod-image">
<h3><a class="toc-backref" href="#id76">Verifying PROD image</a></h3>
<p>Finally, you can verify PROD image by running tests - either with the pulled/built images or
with an arbitrary image.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">verify-prod-image</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_prod-image_verify.svg"><object data="./images/breeze/output_prod-image_verify.svg" style="width: 100%;" type="image/svg+xml">Breeze prod-image verify</object></a>
</div>
</div>
<div class="section" id="breeze-setup">
<h2><a class="toc-backref" href="#id77">Breeze setup</a></h2>
<p>Breeze has tools that you can use to configure defaults and breeze behaviours and perform some maintenance
operations that might be necessary when you add new commands in Breeze. It also allows to configure your
host operating system for Breeze autocompletion.</p>
<p>These are all available flags of <tt class="docutils literal">setup</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup.svg"><object data="./images/breeze/output_setup.svg" style="width: 100%;" type="image/svg+xml">Breeze setup</object></a>
<div class="section" id="breeze-configuration">
<h3><a class="toc-backref" href="#id78">Breeze configuration</a></h3>
<p>You can configure and inspect settings of Breeze command via this command: Python version, Backend used as
well as backend versions.</p>
<p>Another part of configuration is enabling/disabling cheatsheet, asciiart. The cheatsheet and asciiart can
be disabled - they are &quot;nice looking&quot; and cheatsheet
contains useful information for first time users but eventually you might want to disable both if you
find it repetitive and annoying.</p>
<p>With the config setting colour-blind-friendly communication for Breeze messages. By default we communicate
with the users about information/errors/warnings/successes via colour-coded messages, but we can switch
it off by passing <tt class="docutils literal"><span class="pre">--no-colour</span></tt> to config in which case the messages to the user printed by Breeze
will be printed using different schemes (italic/bold/underline) to indicate different kind of messages
rather than colours.</p>
<p>These are all available flags of <tt class="docutils literal">setup config</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup_config.svg"><object data="./images/breeze/output_setup_config.svg" style="width: 100%;" type="image/svg+xml">Breeze setup config</object></a>
</div>
<div class="section" id="setting-up-autocompletion">
<h3><a class="toc-backref" href="#id79">Setting up autocompletion</a></h3>
<p>You get the auto-completion working when you re-enter the shell (follow the instructions printed).
The command will warn you and not reinstall autocomplete if you already did, but you can
also force reinstalling the autocomplete via:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>setup<span class="whitespace"> </span>autocomplete<span class="whitespace"> </span>--force
</pre>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">setup-autocomplete</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup_autocomplete.svg"><object data="./images/breeze/output_setup_autocomplete.svg" style="width: 100%;" type="image/svg+xml">Breeze setup autocomplete</object></a>
</div>
<div class="section" id="breeze-version">
<h3><a class="toc-backref" href="#id80">Breeze version</a></h3>
<p>You can display Breeze version and with <tt class="docutils literal"><span class="pre">--verbose</span></tt> flag it can provide more information: where
Breeze is installed from and details about setup hashes.</p>
<p>These are all available flags of <tt class="docutils literal">version</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup_version.svg"><object data="./images/breeze/output_setup_version.svg" style="width: 100%;" type="image/svg+xml">Breeze version</object></a>
</div>
<div class="section" id="breeze-setup-self-upgrade">
<h3><a class="toc-backref" href="#id81">Breeze setup self-upgrade</a></h3>
<p>You can self-upgrade breeze automatically. These are all available flags of <tt class="docutils literal"><span class="pre">self-upgrade</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup_self-upgrade.svg"><object data="./images/breeze/output_setup_self-upgrade.svg" style="width: 100%;" type="image/svg+xml">Breeze setup self-upgrade</object></a>
</div>
<div class="section" id="regenerating-images-for-documentation">
<h3><a class="toc-backref" href="#id82">Regenerating images for documentation</a></h3>
<p>This documentation contains exported images with &quot;help&quot; of their commands and parameters. You can
regenerate those images that need to be regenerated because their commands changed (usually after
the breeze code has been changed) via <tt class="docutils literal"><span class="pre">regenerate-command-images</span></tt> command. Usually this is done
automatically via pre-commit, but sometimes (for example when <tt class="docutils literal">rich</tt> or <tt class="docutils literal"><span class="pre">rich-click</span></tt> library changes)
you need to regenerate those images.</p>
<p>You can add <tt class="docutils literal"><span class="pre">--force</span></tt> flag (or <tt class="docutils literal"><span class="pre">FORCE=&quot;true&quot;</span></tt> environment variable to regenerate all images (not
only those that need regeneration). You can also run the command with <tt class="docutils literal"><span class="pre">--check-only</span></tt> flag to simply
check if there are any images that need regeneration.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup_regenerate-command-images.svg"><object data="./images/breeze/output_setup_regenerate-command-images.svg" style="width: 100%;" type="image/svg+xml">Breeze setup regenerate-command-images</object></a>
</div>
<div class="section" id="breeze-check-all-params-in-groups">
<h3><a class="toc-backref" href="#id83">Breeze check-all-params-in-groups</a></h3>
<p>When you add a breeze command or modify a parameter, you are also supposed to make sure that &quot;rich groups&quot;
for the command is present and that all parameters are assigned to the right group so they can be
nicely presented in <tt class="docutils literal"><span class="pre">--help</span></tt> output. You can check that via <tt class="docutils literal"><span class="pre">check-all-params-in-groups</span></tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup_check-all-params-in-groups.svg"><object data="./images/breeze/output_setup_check-all-params-in-groups.svg" style="width: 100%;" type="image/svg+xml">Breeze setup check-all-params-in-group</object></a>
</div>
<div class="section" id="breeze-synchronize-local-mounts">
<h3><a class="toc-backref" href="#id84">Breeze synchronize-local-mounts</a></h3>
<p>When you add volumes mounted to docker, they need to be added in <tt class="docutils literal">docker_command_utils.py</tt> - so that they
are added by plain <tt class="docutils literal">docker</tt> command, but they also need to be synchronized with <tt class="docutils literal">local.yml</tt>. This can be
done via <tt class="docutils literal"><span class="pre">synchronize-local-mounts</span></tt> command.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_setup_synchronize-local-mounts.svg"><object data="./images/breeze/output_setup_synchronize-local-mounts.svg" style="width: 100%;" type="image/svg+xml">Breeze setup synchronize-local-mounts</object></a>
</div>
</div>
<div class="section" id="ci-tasks">
<h2><a class="toc-backref" href="#id85">CI tasks</a></h2>
<p>Breeze hase a number of commands that are mostly used in CI environment to perform cleanup.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci.svg"><object data="./images/breeze/output_ci.svg" style="width: 100%;" type="image/svg+xml">Breeze ci commands</object></a>
<div class="section" id="running-resource-check">
<h3><a class="toc-backref" href="#id86">Running resource check</a></h3>
<p>Breeze requires certain resources to be available - disk, memory, CPU. When you enter Breeze's shell,
the resources are checked and information if there is enough resources is displayed. However you can
manually run resource check any time by <tt class="docutils literal">breeze ci <span class="pre">resource-check</span></tt> command.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">resource-check</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci_resource-check.svg"><object data="./images/breeze/output_ci_resource-check.svg" style="width: 100%;" type="image/svg+xml">Breeze ci resource-check</object></a>
</div>
<div class="section" id="freeing-the-space">
<h3><a class="toc-backref" href="#id87">Freeing the space</a></h3>
<p>When our CI runs a job, it needs all memory and disk it can have. We have a Breeze command that frees
the memory and disk space used. You can also use it clear space locally but it performs a few operations
that might be a bit invasive - such are removing swap file and complete pruning of docker disk space used.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">free-space</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci_free-space.svg"><object data="./images/breeze/output_ci_free-space.svg" style="width: 100%;" type="image/svg+xml">Breeze ci free-space</object></a>
</div>
<div class="section" id="fixing-file-directory-ownership">
<h3><a class="toc-backref" href="#id88">Fixing File/Directory Ownership</a></h3>
<p>On Linux, there is a problem with propagating ownership of created files (a known Docker problem). The
files and directories created in the container are not owned by the host user (but by the root user in our
case). This may prevent you from switching branches, for example, if files owned by the root user are
created within your sources. In case you are on a Linux host and have some files in your sources created
by the root user, you can fix the ownership of those files by running :</p>
<pre class="code literal-block">
breeze ci fix-ownership
</pre>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">fix-ownership</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci_fix-ownership.svg"><object data="./images/breeze/output_ci_fix-ownership.svg" style="width: 100%;" type="image/svg+xml">Breeze ci fix-ownership</object></a>
</div>
<div class="section" id="selective-check">
<h3><a class="toc-backref" href="#id89">Selective check</a></h3>
<p>When our CI runs a job, it needs to decide which tests to run, whether to build images and how much the test
should be run on multiple combinations of Python, Kubernetes, Backend versions. In order to optimize time
needed to run the CI Builds. You can also use the tool to test what tests will be run when you provide
a specific commit that Breeze should run the tests on.</p>
<p>The selective-check command will produce the set of <tt class="docutils literal">name=value</tt> pairs of outputs derived
from the context of the commit/PR to be merged via stderr output.</p>
<p>More details about the algorithm used to pick the right tests and the available outputs can be
found in <a class="reference external" href="dev/breeze/SELECTIVE_CHECKS.md">Selective Checks</a>.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">selective-check</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci_selective-check.svg"><object data="./images/breeze/output_ci_selective-check.svg" style="width: 100%;" type="image/svg+xml">Breeze ci selective-check</object></a>
</div>
<div class="section" id="getting-workflow-information">
<h3><a class="toc-backref" href="#id90">Getting workflow information</a></h3>
<p>When our CI runs a job, it might be within one of several workflows. Information about those workflows
is stored in GITHUB_CONTEXT. Rather than using some jq/bash commands, we retrieve the necessary information
(like PR labels, event_type, where the job runs on, job description and convert them into GA outputs.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">get-workflow-info</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci_get-workflow-info.svg"><object data="./images/breeze/output_ci_get-workflow-info.svg" style="width: 100%;" type="image/svg+xml">Breeze ci get-workflow-info</object></a>
</div>
<div class="section" id="finding-backtracking-candidates">
<h3><a class="toc-backref" href="#id91">Finding backtracking candidates</a></h3>
<p>Sometimes the CI build fails because <tt class="docutils literal">pip</tt> timeouts when trying to resolve the latest set of dependencies
for that we have the <tt class="docutils literal"><span class="pre">find-backtracking-candidates</span></tt> command. This command will try to find the
backtracking candidates that might cause the backtracking.</p>
<p>The details on how to use that command are explained in
<a class="reference external" href="dev/MANUALLY_GENERATING_IMAGE_CACHE_AND_CONSTRAINTS.md#figuring-out-backtracking-dependencies">Figuring out backtracking dependencies</a>.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">find-backtracking-candidates</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_ci_find-backtracking-candidates.svg"><object data="./images/breeze/output_ci_find-backtracking-candidates.svg" style="width: 100%;" type="image/svg+xml">Breeze ci find-backtracking-candidates</object></a>
</div>
</div>
<div class="section" id="release-management-tasks">
<h2><a class="toc-backref" href="#id92">Release management tasks</a></h2>
<p>Maintainers also can use Breeze for other purposes (those are commands that regular contributors likely
do not need or have no access to run). Those are usually connected with releasing Airflow:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management.svg"><object data="./images/breeze/output_release-management.svg" style="width: 100%;" type="image/svg+xml">Breeze release management</object></a>
<div class="section" id="airflow-release-commands">
<h3><a class="toc-backref" href="#id93">Airflow release commands</a></h3>
<p>Running airflow release commands is part of the release procedure performed by the release managers
and it is described in detail in <a class="reference external" href="dev/README_RELEASE_AIRFLOW.md">dev</a> .</p>
<div class="section" id="preparing-airflow-packages">
<h4><a class="toc-backref" href="#id94">Preparing airflow packages</a></h4>
<p>You can prepare airflow packages using Breeze:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>prepare-airflow-package
</pre>
<p>This prepares airflow .whl package in the dist folder.</p>
<p>Again, you can specify optional <tt class="docutils literal"><span class="pre">--package-format</span></tt> flag to build selected formats of airflow packages,
default is to build <tt class="docutils literal">both</tt> type of packages <tt class="docutils literal">sdist</tt> and <tt class="docutils literal">wheel</tt>.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>prepare-airflow-package<span class="whitespace"> </span>--package-format<span class="operator">=</span>wheel
</pre>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_prepare-airflow-package.svg"><object data="./images/breeze/output_release-management_prepare-airflow-package.svg" style="width: 100%;" type="image/svg+xml">Breeze release-management prepare-airflow-package</object></a>
</div>
<div class="section" id="start-minor-branch-of-airflow">
<h4><a class="toc-backref" href="#id95">Start minor branch of Airflow</a></h4>
<p>When we create a new minor branch of Airflow, we need to perform a few maintenance tasks. This command
automates it.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>create-minor-branch
</pre>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_create-minor-branch.svg"><object data="./images/breeze/output_release-management_create-minor-branch.svg" style="width: 100%;" type="image/svg+xml">Breeze release-management create-minor-branch</object></a>
</div>
<div class="section" id="start-release-candidate-process">
<h4><a class="toc-backref" href="#id96">Start release candidate process</a></h4>
<p>When we prepare release candidate, we automate some of the steps we need to do.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>start-rc-process
</pre>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_start-rc-process.svg"><object data="./images/breeze/output_release-management_start-rc-process.svg" style="width: 100%;" type="image/svg+xml">Breeze release-management start-rc-process</object></a>
</div>
<div class="section" id="start-release-process">
<h4><a class="toc-backref" href="#id97">Start release process</a></h4>
<p>When we prepare final release, we automate some of the steps we need to do.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>start-release
</pre>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_start-rc-process.svg"><object data="./images/breeze/output_release-management_start-release.svg" style="width: 100%;" type="image/svg+xml">Breeze release-management start-rc-process</object></a>
</div>
<div class="section" id="releasing-production-images">
<h4><a class="toc-backref" href="#id98">Releasing Production images</a></h4>
<p>The <strong>Production image</strong> can be released by release managers who have permissions to push the image. This
happens only when there is an RC candidate or final version of Airflow released.</p>
<p>You release &quot;regular&quot; and &quot;slim&quot; images as separate steps.</p>
<p>Releasing &quot;regular&quot; images:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>release-prod-images<span class="whitespace"> </span>--airflow-version<span class="whitespace"> </span><span class="literal number">2</span>.4.0
</pre>
<p>Or &quot;slim&quot; images:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>release-prod-images<span class="whitespace"> </span>--airflow-version<span class="whitespace"> </span><span class="literal number">2</span>.4.0<span class="whitespace"> </span>--slim-images
</pre>
<p>By default when you are releasing the &quot;final&quot; image, we also tag image with &quot;latest&quot; tags but this
step can be skipped if you pass the <tt class="docutils literal"><span class="pre">--skip-latest</span></tt> flag.</p>
<p>These are all of the available flags for the <tt class="docutils literal"><span class="pre">release-prod-images</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_release-prod-images.svg"><object data="./images/breeze/output_release-management_release-prod-images.svg" style="width: 100%;" type="image/svg+xml">Breeze release management release prod images</object></a>
</div>
</div>
<div class="section" id="provider-release-commands">
<h3><a class="toc-backref" href="#id99">Provider release commands</a></h3>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">BREEZE.rst</tt>, line 967); <em><a href="#id8">backlink</a></em></p>
Duplicate explicit target name: &quot;dev&quot;.</div>
<p>Preparing provider release is part of the release procedure by the release managers
and it is described in detail in <a class="reference external" href="dev/README_RELEASE_PROVIDER_PACKAGES.md">dev</a> .</p>
<div class="section" id="preparing-provider-documentation">
<h4><a class="toc-backref" href="#id100">Preparing provider documentation</a></h4>
<p>You can use Breeze to prepare provider documentation.</p>
<p>The below example perform documentation preparation for provider packages.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>prepare-provider-documentation
</pre>
<p>You can also add <tt class="docutils literal"><span class="pre">--answer</span> yes</tt> to perform non-interactive build.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_prepare-provider-documentation.svg"><object data="./images/breeze/output_release-management_prepare-provider-documentation.svg" style="width: 100%;" type="image/svg+xml">Breeze prepare-provider-documentation</object></a>
</div>
<div class="section" id="preparing-provider-packages">
<h4><a class="toc-backref" href="#id101">Preparing provider packages</a></h4>
<p>You can use Breeze to prepare provider packages.</p>
<p>The packages are prepared in <tt class="docutils literal">dist</tt> folder. Note, that this command cleans up the <tt class="docutils literal">dist</tt> folder
before running, so you should run it before generating airflow package below as it will be removed.</p>
<p>The below example builds provider packages in the wheel format.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>prepare-provider-packages
</pre>
<p>If you run this command without packages, you will prepare all packages, you can however specify
providers that you would like to build. By default <tt class="docutils literal">both</tt> types of packages are prepared (
<tt class="docutils literal">wheel</tt> and <tt class="docutils literal">sdist</tt>, but you can change it providing optional --package-format flag.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>prepare-provider-packages<span class="whitespace"> </span>google<span class="whitespace"> </span>amazon
</pre>
<p>You can see all providers available by running this command:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>prepare-provider-packages<span class="whitespace"> </span>--help
</pre>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_prepare-provider-packages.svg"><object data="./images/breeze/output_release-management_prepare-provider-packages.svg" style="width: 100%;" type="image/svg+xml">Breeze prepare-provider-packages</object></a>
</div>
<div class="section" id="installing-provider-packages">
<h4><a class="toc-backref" href="#id102">Installing provider packages</a></h4>
<p>In some cases we want to just see if the provider packages generated can be installed with airflow without
verifying them. This happens automatically on CI for sdist pcackages but you can also run it manually if you
just prepared provider packages and they are present in <tt class="docutils literal">dist</tt> folder.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>install-provider-packages
</pre>
<p>You can also run the verification with an earlier airflow version to check for compatibility.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>install-provider-packages<span class="whitespace"> </span>--use-airflow-version<span class="whitespace"> </span><span class="literal number">2</span>.4.0
</pre>
<p>All the command parameters are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_install-provider-packages.svg"><object data="./images/breeze/output_release-management_install-provider-packages.svg" style="width: 100%;" type="image/svg+xml">Breeze install-provider-packages</object></a>
</div>
<div class="section" id="verifying-provider-packages">
<h4><a class="toc-backref" href="#id103">Verifying provider packages</a></h4>
<p>Breeze can also be used to verify if provider classes are importable and if they are following the
right naming conventions. This happens automatically on CI but you can also run it manually if you
just prepared provider packages and they are present in <tt class="docutils literal">dist</tt> folder.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>verify-provider-packages
</pre>
<p>You can also run the verification with an earlier airflow version to check for compatibility.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>verify-provider-packages<span class="whitespace"> </span>--use-airflow-version<span class="whitespace"> </span><span class="literal number">2</span>.4.0
</pre>
<p>All the command parameters are here:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_verify-provider-packages.svg"><object data="./images/breeze/output_release-management_verify-provider-packages.svg" style="width: 100%;" type="image/svg+xml">Breeze verify-provider-packages</object></a>
</div>
<div class="section" id="generating-providers-metadata">
<h4><a class="toc-backref" href="#id104">Generating Providers Metadata</a></h4>
<p>The release manager can generate providers metadata per provider version - information about provider versions
including the associated Airflow version for the provider version (i.e first airflow version released after the
provider has been released) and date of the release of the provider version.</p>
<p>These are all of the available flags for the <tt class="docutils literal"><span class="pre">generate-providers-metadata</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_generate-providers-metadata.svg"><object data="./images/breeze/output_release-management_generate-providers-metadata.svg" style="width: 100%;" type="image/svg+xml">Breeze release management generate providers metadata</object></a>
</div>
<div class="section" id="generating-provider-issue">
<h4><a class="toc-backref" href="#id105">Generating Provider Issue</a></h4>
<p>You can use Breeze to generate a provider issue when you release new providers.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_generate-issue-content-providers.svg"><object data="./images/breeze/output_release-management_generate-issue-content-providers.svg" style="width: 100%;" type="image/svg+xml">Breeze generate-issue-content-providers</object></a>
</div>
</div>
<div class="section" id="other-release-commands">
<h3><a class="toc-backref" href="#id106">Other release commands</a></h3>
<div class="section" id="publishing-the-documentation">
<h4><a class="toc-backref" href="#id107">Publishing the documentation</a></h4>
<p>To publish the documentation generated by <tt class="docutils literal"><span class="pre">build-docs</span></tt> in Breeze to <tt class="docutils literal"><span class="pre">airflow-site</span></tt>,
use the <tt class="docutils literal"><span class="pre">release-management</span> <span class="pre">publish-docs</span></tt> command:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>publish-docs
</pre>
<p>The publishing documentation consists  steps:</p>
<ul class="simple">
<li>checking out the latest <tt class="docutils literal">main</tt> of cloned <tt class="docutils literal"><span class="pre">airflow-site</span></tt></li>
<li>copying the documentation to <tt class="docutils literal"><span class="pre">airflow-site</span></tt></li>
<li>running post-docs scripts on the docs to generate back referencing HTML for new versions of docs</li>
</ul>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>publish-docs<span class="whitespace"> </span>--package-filter<span class="whitespace"> </span>apache-airflow-providers-amazon
</pre>
<p>The flag <tt class="docutils literal"><span class="pre">--package-filter</span></tt> can be used to selectively publish docs during a release. It can take
values such as apache-airflow, helm-chart, apache-airflow-providers, or any individual providers.
The documentation publication happens based on this flag.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>publish-docs<span class="whitespace"> </span>--override-versioned
</pre>
<p>The flag <tt class="docutils literal"><span class="pre">--override-versioned</span></tt> is a boolean flag that is used to override the versioned directories
while publishing the documentation.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>publish-docs<span class="whitespace"> </span>--airflow-site-directory
</pre>
<p>You can also use shorthand names as arguments instead of using the full names
for airflow providers. To find the short hand names, follow the instructions in <a href="#id9"><span class="problematic" id="id10">:ref:`generating_short_form_names`</span></a>.</p>
<div class="system-message" id="id9">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">BREEZE.rst</tt>, line 2228); <em><a href="#id10">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<p>The flag <tt class="docutils literal"><span class="pre">--airflow-site-directory</span></tt> takes the path of the cloned <tt class="docutils literal"><span class="pre">airflow-site</span></tt>. The command will
not proceed if this is an invalid path.</p>
<p>When you have multi-processor machine docs publishing can be vastly sped up by using <tt class="docutils literal"><span class="pre">--run-in-parallel</span></tt> option when
publishing docs for multiple providers.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">release-management</span> <span class="pre">publish-docs</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_publish-docs.svg"><object data="./images/breeze/output_release-management_publish-docs.svg" style="width: 100%;" type="image/svg+xml">Breeze Publish documentation</object></a>
</div>
</div>
<div class="section" id="id11">
<span id="generating-short-form-names-publish"></span><h3><a class="toc-backref" href="#id108">Generating short form names for Providers</a></h3>
<p>Skip the <tt class="docutils literal"><span class="pre">apache-airflow-providers-</span></tt> from the usual provider full names.
Now with the remaining part, replace every <tt class="docutils literal"><span class="pre">dash(&quot;-&quot;)</span></tt> with a <tt class="docutils literal"><span class="pre">dot(&quot;.&quot;)</span></tt>.</p>
<p>Example:
If the provider name is <tt class="docutils literal"><span class="pre">apache-airflow-providers-cncf-kubernetes</span></tt>, it will be <tt class="docutils literal">cncf.kubernetes</tt>.</p>
<div class="section" id="adding-back-referencing-html-for-the-documentation">
<h4><a class="toc-backref" href="#id109">Adding back referencing HTML for the documentation</a></h4>
<p>To add back references to the documentation generated by <tt class="docutils literal"><span class="pre">build-docs</span></tt> in Breeze to <tt class="docutils literal"><span class="pre">airflow-site</span></tt>,
use the <tt class="docutils literal"><span class="pre">release-management</span> <span class="pre">add-back-references</span></tt> command. This is important to support backward compatibility
the airflow documentation.</p>
<p>You have to specify which packages you run it on. For example you can run it for all providers:</p>
<pre class="code bash literal-block">
release-management<span class="whitespace"> </span>add-back-references<span class="whitespace"> </span>--airflow-site-directory<span class="whitespace"> </span>DIRECTORY<span class="whitespace"> </span>all-providers
</pre>
<p>The flag <tt class="docutils literal"><span class="pre">--airflow-site-directory</span></tt> takes the path of the cloned <tt class="docutils literal"><span class="pre">airflow-site</span></tt>. The command will
not proceed if this is an invalid path.</p>
<p>You can also run the command for apache-airflow (core documentation):</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>publish-docs<span class="whitespace"> </span>--airflow-site-directory<span class="whitespace"> </span>DIRECTORY<span class="whitespace"> </span>apache-airflow
</pre>
<p>Also for helm-chart package:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>publish-docs<span class="whitespace"> </span>--airflow-site-directory<span class="whitespace"> </span>DIRECTORY<span class="whitespace"> </span>helm-chart
</pre>
<p>You can also manually specify (it's auto-completable) list of packages to run the command for including individual
providers - you can mix apache-airflow, helm-chart and provider packages this way:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>publish-docs<span class="whitespace"> </span>--airflow-site-directory<span class="whitespace"> </span>DIRECTORY<span class="whitespace"> </span>apache.airflow<span class="whitespace"> </span>apache.beam<span class="whitespace"> </span>google
</pre>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">release-management</span> <span class="pre">add-back-references</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_add-back-references.svg"><object data=".images/breeze/output_release-management_add-back-references.svg" style="width: 100%;" type="image/svg+xml">Breeze Add Back References</object></a>
</div>
<div class="section" id="generating-constraints">
<h4><a class="toc-backref" href="#id110">Generating constraints</a></h4>
<p>Whenever <tt class="docutils literal">pyproject.toml</tt> gets modified, the CI main job will re-generate constraint files. Those constraint
files are stored in separated orphan branches: <tt class="docutils literal"><span class="pre">constraints-main</span></tt>, <tt class="docutils literal"><span class="pre">constraints-2-0</span></tt>.</p>
<p>Those are constraint files as described in detail in the
<a class="reference external" href="CONTRIBUTING.rst#pinned-constraint-files">CONTRIBUTING.rst#pinned-constraint-files</a> contributing documentation.</p>
<p>You can use <tt class="docutils literal">breeze <span class="pre">release-management</span> <span class="pre">generate-constraints</span></tt> command to manually generate constraints for
all or selected python version and single constraint mode like this:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In order to generate constraints, you need to build all images with <tt class="docutils literal"><span class="pre">--upgrade-to-newer-dependencies</span></tt>
flag - for all python versions.</p>
</div>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>release-management<span class="whitespace"> </span>generate-constraints<span class="whitespace"> </span>--airflow-constraints-mode<span class="whitespace"> </span>constraints
</pre>
<p>Constraints are generated separately for each python version and there are separate constraints modes:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>'constraints' - those are constraints generated by matching the current airflow version from sources</dt>
<dd>and providers that are installed from PyPI. Those are constraints used by the users who want to
install airflow with pip.</dd>
</dl>
</li>
<li>&quot;constraints-source-providers&quot; - those are constraints generated by using providers installed from
current sources. While adding new providers their dependencies might change, so this set of providers
is the current set of the constraints for airflow and providers from the current main sources.
Those providers are used by CI system to keep &quot;stable&quot; set of constraints.</li>
<li>&quot;constraints-no-providers&quot; - those are constraints generated from only Apache Airflow, without any
providers. If you want to manage airflow separately and then add providers individually, you can
use those.</li>
</ul>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">generate-constraints</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_generate-constraints.svg"><object data="./images/breeze/output_release-management_generate-constraints.svg" style="width: 100%;" type="image/svg+xml">Breeze generate-constraints</object></a>
<p>In case someone modifies <tt class="docutils literal">pyproject.toml</tt>, the scheduled CI Tests automatically upgrades and
pushes changes to the constraint files, however you can also perform test run of this locally using
the procedure described in the
<a class="reference external" href="dev/MANUALLY_GENERATING_IMAGE_CACHE_AND_CONSTRAINTS.md">Manually generating image cache and constraints</a>
which utilises multiple processors on your local machine to generate such constraints faster.</p>
<p>This bumps the constraint files to latest versions and stores hash of <tt class="docutils literal">pyproject.toml</tt>. The generated constraint
and <tt class="docutils literal">pyproject.toml</tt> hash files are stored in the <tt class="docutils literal">files</tt> folder and while generating the constraints diff
of changes vs the previous constraint files is printed.</p>
</div>
<div class="section" id="updating-constraints">
<h4><a class="toc-backref" href="#id111">Updating constraints</a></h4>
<p>Sometimes (very rarely) we might want to update individual packages in constraints that we generated and
tagged already in the past. This can be done using <tt class="docutils literal">breeze <span class="pre">release-management</span> <span class="pre">update-constraints</span></tt> command.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">update-constraints</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_release-management_update-constraints.svg"><object data="./images/breeze/output_release-management_update-constraints.svg" style="width: 100%;" type="image/svg+xml">Breeze update-constraints</object></a>
<p>You can read more details about what happens when you update constraints in the
<a class="reference external" href="dev/MANUALLY_GENERATING_IMAGE_CACHE_AND_CONSTRAINTS.md">Manually generating image cache and constraints</a></p>
</div>
<div class="section" id="cleaning-up-of-old-providers">
<h4><a class="toc-backref" href="#id112">Cleaning up of old providers</a></h4>
<p>During the provider releases, we need to clean up the older provider versions in the SVN release folder.
Earlier this was done using a script, but now it is being migrated to a breeze command to ease the life of
release managers for providers. This can be achieved using <tt class="docutils literal">breeze <span class="pre">release-management</span> <span class="pre">clean-old-provider-artifacts</span></tt>
command.</p>
<p>These are all available flags of <tt class="docutils literal"><span class="pre">clean-old-provider-artifacts</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/images/breeze/output_release-management_clean-old-provider-artifacts.svg"><object data="./images/breeze/images/breeze/output_release-management_clean-old-provider-artifacts.svg" style="width: 100%;" type="image/svg+xml">Breeze Clean Old Provider Artifacts</object></a>
</div>
</div>
</div>
<div class="section" id="sbom-generation-tasks">
<h2><a class="toc-backref" href="#id113">SBOM generation tasks</a></h2>
<p>Maintainers also can use Breeze for SBOM generation:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_sbom.svg"><object data="./images/breeze/output_sbom.svg" style="width: 100%;" type="image/svg+xml">Breeze sbom</object></a>
<div class="section" id="generating-sbom-information">
<h3><a class="toc-backref" href="#id114">Generating SBOM information</a></h3>
<p>Thanks to our constraints captured for all versions of Airflow we can easily generate SBOM information for
Apache Airflow. SBOM information contains information about Airflow dependencies that are possible to consume
by our users and allow them to determine whether security issues in dependencies affect them. The SBOM
information is written directly to <tt class="docutils literal"><span class="pre">docs-archive</span></tt> in airflow-site repository.</p>
<p>These are all of the available flags for the <tt class="docutils literal"><span class="pre">update-sbom-information</span></tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_sbomt_update-sbom-information.svg"><object data="./images/breeze/output_sbom_update-sbom-information.svg" style="width: 100%;" type="image/svg+xml">Breeze update sbom information</object></a>
</div>
<div class="section" id="build-all-airflow-images">
<h3><a class="toc-backref" href="#id115">Build all airflow images</a></h3>
<p>In order to generate providers requirements, we need docker images with all airflow versions pre-installed,
such images are built with the <tt class="docutils literal"><span class="pre">build-all-airflow-images</span></tt> command.
This command will build one docker image per python version, with all the airflow versions &gt;=2.0.0 compatible.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_sbom_build-all-airflow-images.svg"><object data="./images/breeze/output_sbom_build-all-airflow-images.svg.svg" style="width: 100%;" type="image/svg+xml">Breeze build all airflow images</object></a>
</div>
<div class="section" id="generating-provider-requirements">
<h3><a class="toc-backref" href="#id116">Generating Provider requirements</a></h3>
<p>In order to generate SBOM information for providers, we need to generate requirements for them. This is
done by the <tt class="docutils literal"><span class="pre">generate-providers-requirements</span></tt> command. This command generates requirements for the
selected provider and python version, using the airflow version specified.</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output_sbom_generate-providers-requirements.svg"><object data="./images/breeze/output_sbom_generate-providers-requirements.svg" style="width: 100%;" type="image/svg+xml">Breeze generate SBOM provider requirements</object></a>
</div>
</div>
</div>
<div class="section" id="details-of-breeze-usage">
<h1><a class="toc-backref" href="#id117">Details of Breeze usage</a></h1>
<div class="section" id="database-volumes-in-breeze">
<h2><a class="toc-backref" href="#id118">Database volumes in Breeze</a></h2>
<p>Breeze keeps data for all it's integration in named docker volumes. Each backend and integration
keeps data in their own volume. Those volumes are persisted until <tt class="docutils literal">breeze down</tt> command.
You can also preserve the volumes by adding flag <tt class="docutils literal"><span class="pre">--preserve-volumes</span></tt> when you run the command.
Then, next time when you start Breeze, it will have the data pre-populated.</p>
<p>These are all available flags of <tt class="docutils literal">down</tt> command:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/apache/airflow/main/images/breeze/output-down.svg"><object data="./images/breeze/output-down.svg" style="width: 100%;" type="image/svg+xml">Breeze down</object></a>
</div>
<div class="section" id="additional-tools">
<h2><a class="toc-backref" href="#id119">Additional tools</a></h2>
<p>To shrink the Docker image, not all tools are pre-installed in the Docker image. But we have made sure that there
is an easy process to install additional tools.</p>
<p>Additional tools are installed in <tt class="docutils literal">/files/bin</tt>. This path is added to <tt class="docutils literal">$PATH</tt>, so your shell will
automatically autocomplete files that are in that directory. You can also keep the binaries for your tools
in this directory if you need to.</p>
<p><strong>Installation scripts</strong></p>
<p>For the development convenience, we have also provided installation scripts for commonly used tools. They are
installed to <tt class="docutils literal">/files/opt/</tt>, so they are preserved after restarting the Breeze environment. Each script
is also available in <tt class="docutils literal">$PATH</tt>, so just type <tt class="docutils literal">install_&lt;TAB&gt;</tt> to get a list of tools.</p>
<p>Currently available scripts:</p>
<ul class="simple">
<li><tt class="docutils literal">install_aws.sh</tt> - installs <a class="reference external" href="https://aws.amazon.com/cli/">the AWS CLI</a> including</li>
<li><tt class="docutils literal">install_az.sh</tt> - installs <a class="reference external" href="https://github.com/Azure/azure-cli">the Azure CLI</a> including</li>
<li><tt class="docutils literal">install_gcloud.sh</tt> - installs <a class="reference external" href="https://cloud.google.com/sdk">the Google Cloud SDK</a> including
<tt class="docutils literal">gcloud</tt>, <tt class="docutils literal">gsutil</tt>.</li>
<li><tt class="docutils literal">install_imgcat.sh</tt> - installs <a class="reference external" href="https://iterm2.com/documentation-images.html">imgcat - Inline Images Protocol</a>
for iTerm2 (Mac OS only)</li>
<li><tt class="docutils literal">install_java.sh</tt> - installs <a class="reference external" href="https://openjdk.java.net/">the OpenJDK 8u41</a></li>
<li><tt class="docutils literal">install_kubectl.sh</tt> - installs <a class="reference external" href="https://kubernetes.io/docs/reference/kubectl/kubectl/">the Kubernetes command-line tool, kubectl</a></li>
<li><tt class="docutils literal">install_snowsql.sh</tt> - installs <a class="reference external" href="https://docs.snowflake.com/en/user-guide/snowsql.html">SnowSQL</a></li>
<li><tt class="docutils literal">install_terraform.sh</tt> - installs <a class="reference external" href="https://www.terraform.io/docs/index.html">Terraform</a></li>
</ul>
</div>
<div class="section" id="launching-breeze-integrations">
<h2><a class="toc-backref" href="#id120">Launching Breeze integrations</a></h2>
<p>When Breeze starts, it can start additional integrations. Those are additional docker containers
that are started in the same docker-compose command. Those are required by some of the tests
as described in <a class="reference external" href="TESTING.rst#airflow-integration-tests">TESTING.rst#airflow-integration-tests</a>.</p>
<p>By default Breeze starts only airflow container without any integration enabled. If you selected
<tt class="docutils literal">postgres</tt> or <tt class="docutils literal">mysql</tt> backend, the container for the selected backend is also started (but only the one
that is selected). You can start the additional integrations by passing <tt class="docutils literal"><span class="pre">--integration</span></tt> flag
with appropriate integration name when starting Breeze. You can specify several <tt class="docutils literal"><span class="pre">--integration</span></tt> flags
to start more than one integration at a time.
Finally you can specify <tt class="docutils literal"><span class="pre">--integration</span> <span class="pre">all-testable</span></tt> to start all testable integrations and
<tt class="docutils literal"><span class="pre">--integration</span> all</tt> to enable all integrations.</p>
<p>Once integration is started, it will continue to run until the environment is stopped with
<tt class="docutils literal">breeze down</tt> command.</p>
<p>Note that running integrations uses significant resources - CPU and memory.</p>
</div>
<div class="section" id="using-local-virtualenv-environment-in-your-host-ide">
<h2><a class="toc-backref" href="#id121">Using local virtualenv environment in Your Host IDE</a></h2>
<p>You can set up your host IDE (for example, IntelliJ's PyCharm/Idea) to work with Breeze
and benefit from all the features provided by your IDE, such as local and remote debugging,
language auto-completion, documentation support, etc.</p>
<p>To use your host IDE with Breeze:</p>
<ol class="arabic">
<li><p class="first">Create a local virtual environment:</p>
<p>You can use any of the following wrappers to create and manage your virtual environments:
<a class="reference external" href="https://github.com/pyenv/pyenv">pyenv</a>, <a class="reference external" href="https://github.com/pyenv/pyenv-virtualenv">pyenv-virtualenv</a>,
or <a class="reference external" href="https://virtualenvwrapper.readthedocs.io/en/latest/">virtualenvwrapper</a>.</p>
</li>
<li><p class="first">Use the right command to activate the virtualenv (<tt class="docutils literal">workon</tt> if you use virtualenvwrapper or
<tt class="docutils literal">pyenv activate</tt> if you use pyenv.</p>
</li>
<li><p class="first">Initialize the created local virtualenv:</p>
</li>
</ol>
<pre class="code bash literal-block">
./scripts/tools/initialize_virtualenv.py
</pre>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure that you use the right Python version in this command - matching the Python version you have
in your local virtualenv. If you don't, you will get strange conflicts.</p>
</div>
<ol class="arabic simple" start="4">
<li>Select the virtualenv you created as the project's default virtualenv in your IDE.</li>
</ol>
<p>Note that you can also use the local virtualenv for Airflow development without Breeze.
This is a lightweight solution that has its own limitations.</p>
<p>More details on using the local virtualenv are available in the <a class="reference external" href="LOCAL_VIRTUALENV.rst">LOCAL_VIRTUALENV.rst</a>.</p>
</div>
</div>
<div class="section" id="internal-details-of-breeze">
<h1><a class="toc-backref" href="#id122">Internal details of Breeze</a></h1>
<div class="section" id="airflow-directory-structure-inside-container">
<h2><a class="toc-backref" href="#id123">Airflow directory structure inside container</a></h2>
<p>When you are in the CI container, the following directories are used:</p>
<pre class="code text literal-block">
/opt/airflow - Contains sources of Airflow mounted from the host (AIRFLOW_SOURCES).
/root/airflow - Contains all the &quot;dynamic&quot; Airflow files (AIRFLOW_HOME), such as:
    airflow.db - sqlite database in case sqlite is used;
    logs - logs from Airflow executions;
    unittest.cfg - unit test configuration generated when entering the environment;
    webserver_config.py - webserver configuration generated when running Airflow in the container.
/files - files mounted from &quot;files&quot; folder in your sources. You can edit them in the host as well
    dags - this is the folder where Airflow DAGs are read from
    airflow-breeze-config - this is where you can keep your own customization configuration of breeze
</pre>
<p>Note that when running in your local environment, the <tt class="docutils literal">/root/airflow/logs</tt> folder is actually mounted
from your <tt class="docutils literal">logs</tt> directory in the Airflow sources, so all logs created in the container are automatically
visible in the host as well. Every time you enter the container, the <tt class="docutils literal">logs</tt> directory is
cleaned so that logs do not accumulate.</p>
<p>When you are in the production container, the following directories are used:</p>
<pre class="code text literal-block">
/opt/airflow - Contains sources of Airflow mounted from the host (AIRFLOW_SOURCES).
/root/airflow - Contains all the &quot;dynamic&quot; Airflow files (AIRFLOW_HOME), such as:
    airflow.db - sqlite database in case sqlite is used;
    logs - logs from Airflow executions;
    unittest.cfg - unit test configuration generated when entering the environment;
    webserver_config.py - webserver configuration generated when running Airflow in the container.
/files - files mounted from &quot;files&quot; folder in your sources. You can edit them in the host as well
    dags - this is the folder where Airflow DAGs are read from
</pre>
<p>Note that when running in your local environment, the <tt class="docutils literal">/root/airflow/logs</tt> folder is actually mounted
from your <tt class="docutils literal">logs</tt> directory in the Airflow sources, so all logs created in the container are automatically
visible in the host as well. Every time you enter the container, the <tt class="docutils literal">logs</tt> directory is
cleaned so that logs do not accumulate.</p>
</div>
<div class="section" id="setting-default-answers-for-user-interaction">
<h2><a class="toc-backref" href="#id124">Setting default answers for user interaction</a></h2>
<p>Sometimes during the build, you are asked whether to perform an action, skip it, or quit. This happens
when rebuilding or removing an image and in few other cases - actions that take a lot of time
or could be potentially destructive. You can force answer to the questions by providing an
<tt class="docutils literal"><span class="pre">--answer</span></tt> flag in the commands that support it.</p>
<p>For automation scripts, you can export the <tt class="docutils literal">ANSWER</tt> variable (and set it to
<tt class="docutils literal">y</tt>, <tt class="docutils literal">n</tt>, <tt class="docutils literal">q</tt>, <tt class="docutils literal">yes</tt>, <tt class="docutils literal">no</tt>, <tt class="docutils literal">quit</tt> - in all case combinations).</p>
<pre class="code literal-block">
export ANSWER=&quot;yes&quot;
</pre>
</div>
<div class="section" id="mounting-local-sources-to-breeze">
<h2><a class="toc-backref" href="#id125">Mounting Local Sources to Breeze</a></h2>
<p>Important sources of Airflow are mounted inside the <tt class="docutils literal">airflow</tt> container that you enter.
This means that you can continue editing your changes on the host in your favourite IDE and have them
visible in the Docker immediately and ready to test without rebuilding images. You can modify mounting
options by specifying <tt class="docutils literal"><span class="pre">--mount-sources</span></tt> flag when running Breeze. For example, in the case of <tt class="docutils literal"><span class="pre">--mount-sources</span> skip</tt> you will have sources
embedded in the container and changes to these sources will not be persistent.</p>
<p>After you run Breeze for the first time, you will have empty directory <tt class="docutils literal">files</tt> in your source code,
which will be mapped to <tt class="docutils literal">/files</tt> in your Docker container. You can pass there any files you need to
configure and run Docker. They will not be removed between Docker runs.</p>
<p>By default <tt class="docutils literal">/files/dags</tt> folder is mounted from your local <tt class="docutils literal"><span class="pre">&lt;AIRFLOW_SOURCES&gt;/files/dags</span></tt> and this is
the directory used by airflow scheduler and webserver to scan dags for. You can use it to test your dags
from local sources in Airflow. If you wish to add local DAGs that can be run by Breeze.</p>
<p>The <tt class="docutils literal"><span class="pre">/files/airflow-breeze-config</span></tt> folder contains configuration files that might be used to
customize your breeze instance. Those files will be kept across checking out a code from different
branches and stopping/starting breeze so you can keep your configuration there and use it continuously while
you switch to different source code versions.</p>
</div>
<div class="section" id="port-forwarding">
<h2><a class="toc-backref" href="#id126">Port Forwarding</a></h2>
<p>When you run Airflow Breeze, the following ports are automatically forwarded:</p>
<ul class="simple">
<li>12322 -&gt; forwarded to Airflow ssh server -&gt; airflow:22</li>
<li>28080 -&gt; forwarded to Airflow webserver -&gt; airflow:8080</li>
<li>25555 -&gt; forwarded to Flower dashboard -&gt; airflow:5555</li>
<li>25433 -&gt; forwarded to Postgres database -&gt; postgres:5432</li>
<li>23306 -&gt; forwarded to MySQL database  -&gt; mysql:3306</li>
<li>21433 -&gt; forwarded to MSSQL database  -&gt; mssql:1443</li>
<li>26379 -&gt; forwarded to Redis broker -&gt; redis:6379</li>
</ul>
<p>You can connect to these ports/databases using:</p>
<ul class="simple">
<li>ssh connection for remote debugging: ssh -p 12322 <a class="reference external" href="mailto:airflow&#64;127.0.0.1">airflow&#64;127.0.0.1</a> pw: airflow</li>
<li>Webserver: <a class="reference external" href="http://127.0.0.1:28080">http://127.0.0.1:28080</a></li>
<li>Flower:    <a class="reference external" href="http://127.0.0.1:25555">http://127.0.0.1:25555</a></li>
<li>Postgres:  <a class="reference external" href="jdbc:postgresql://127.0.0.1:25433/airflow?user=postgres&amp;password=airflow">jdbc:postgresql://127.0.0.1:25433/airflow?user=postgres&amp;password=airflow</a></li>
<li>Mysql:     <a class="reference external" href="jdbc:mysql://127.0.0.1:23306/airflow?user=root">jdbc:mysql://127.0.0.1:23306/airflow?user=root</a></li>
<li>MSSQL:     <a class="reference external" href="jdbc:sqlserver://127.0.0.1:21433;databaseName=airflow;user=sa;password=Airflow123">jdbc:sqlserver://127.0.0.1:21433;databaseName=airflow;user=sa;password=Airflow123</a></li>
<li>Redis:     redis://127.0.0.1:26379/0</li>
</ul>
<p>If you do not use <tt class="docutils literal"><span class="pre">start-airflow</span></tt> command, you can start the webserver manually with
the <tt class="docutils literal">airflow webserver</tt> command if you want to run it. You can use <tt class="docutils literal">tmux</tt> to multiply terminals.
You may need to create a user prior to running the webserver in order to log in.
This can be done with the following command:</p>
<pre class="code bash literal-block">
airflow<span class="whitespace"> </span>users<span class="whitespace"> </span>create<span class="whitespace"> </span>--role<span class="whitespace"> </span>Admin<span class="whitespace"> </span>--username<span class="whitespace"> </span>admin<span class="whitespace"> </span>--password<span class="whitespace"> </span>admin<span class="whitespace"> </span>--email<span class="whitespace"> </span>admin&#64;example.com<span class="whitespace"> </span>--firstname<span class="whitespace"> </span>foo<span class="whitespace"> </span>--lastname<span class="whitespace"> </span>bar
</pre>
<p>For databases, you need to run <tt class="docutils literal">airflow db reset</tt> at least once (or run some tests) after you started
Airflow Breeze to get the database/tables created. You can connect to databases with IDE or any other
database client:</p>
<div align="center">
    <img src="images/database_view.png" width="640"
         alt="Airflow Breeze - Database view">
</div><p>You can change the used host port numbers by setting appropriate environment variables:</p>
<ul class="simple">
<li><tt class="docutils literal">SSH_PORT</tt></li>
<li><tt class="docutils literal">WEBSERVER_HOST_PORT</tt></li>
<li><tt class="docutils literal">POSTGRES_HOST_PORT</tt></li>
<li><tt class="docutils literal">MYSQL_HOST_PORT</tt></li>
<li><tt class="docutils literal">MSSQL_HOST_PORT</tt></li>
<li><tt class="docutils literal">FLOWER_HOST_PORT</tt></li>
<li><tt class="docutils literal">REDIS_HOST_PORT</tt></li>
</ul>
<p>If you set these variables, next time when you enter the environment the new ports should be in effect.</p>
</div>
<div class="section" id="managing-dependencies">
<h2><a class="toc-backref" href="#id127">Managing Dependencies</a></h2>
<p>There are couple of things you might want to do when adding/changing dependencies when developing with
Breeze. You can add dependencies temporarily (which will last until you exit Breeze shell), or you might
want to add them permanently (which require you to rebuild the image). Also there are different things
you need to do when you are adding system level (debian) level, Python (pip) dependencies or Node (yarn)
dependencies for the webserver.</p>
<div class="section" id="python-dependencies">
<h3><a class="toc-backref" href="#id128">Python dependencies</a></h3>
<p>For temporary adding and modifying the dependencies, you just (in Breeze shell) run
<tt class="docutils literal">pip install &lt;dependency&gt;</tt> or similar - in the same way as you would do it
in your local environment. You can also use <tt class="docutils literal">pip install <span class="pre">-r</span> /files/requirements.txt</tt> to install several
dependencies - if you place your requirements file in <tt class="docutils literal">files</tt> directory. Those dependencies will
disappear when you exit Breeze shell.</p>
<p>When you want to add dependencies permanently, then it depends what kind of dependency you add.</p>
<p>If you want to add core dependency that should always be installed - you need to add it to <tt class="docutils literal">pyproject.toml</tt>
to <tt class="docutils literal">dependencies</tt> section. If you want to add it to one of the optional core extras, you should
add it in the extra definition in <tt class="docutils literal">pyproject.toml</tt> (you need to find out where it is defined).
If you want to add it to one of the providers, you need to add it to the <tt class="docutils literal">provider.yaml</tt> file in the provider
directory - but remember that this should be followed by running pre-commit that will automatically update
the <tt class="docutils literal">pyproject.toml</tt> with the new dependencies as the <tt class="docutils literal">provider.yaml</tt> files are not used directly, they
are used to update <tt class="docutils literal">pyproject.toml</tt> file:</p>
<pre class="code bash literal-block">
pre-commit<span class="whitespace"> </span>run<span class="whitespace"> </span>update-providers-dependencies<span class="whitespace">  </span>--all-files
</pre>
<p>You can also run the pre-commit by <tt class="docutils literal">breeze <span class="pre">static-checks</span> <span class="pre">--type</span> <span class="pre">update-providers-dependencies</span> <span class="pre">--all-files</span></tt>
command - which provides autocomplete.</p>
<p>After you've updated the dependencies, you need to rebuild the image:</p>
<p>Breeze will automatically detect when you updated dependencies and it will propose you to build image next
time when you enter it. You can answer <tt class="docutils literal">y</tt> during 10 seconds to get it done for you.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>ci-image<span class="whitespace"> </span>build
</pre>
<p>Sometimes, when you have conflicting change in dependencies (i.e. dependencies in the old constraints
are conflicting with the new specification, you might want to build the image with
<tt class="docutils literal"><span class="pre">--upgrade-to-newer-dependencies</span></tt> flag:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>ci-image<span class="whitespace"> </span>build<span class="whitespace"> </span>--upgrade-to-newer-dependencies
</pre>
</div>
<div class="section" id="system-debian-dependencies">
<h3><a class="toc-backref" href="#id129">System (debian) dependencies</a></h3>
<p>You can install <tt class="docutils literal"><span class="pre">apt-get</span></tt> dependencies temporarily by running <tt class="docutils literal"><span class="pre">apt-get</span> install &lt;dependency&gt;</tt> in
Breeze shell. Those dependencies will disappear when you exit Breeze shell.</p>
<p>When you want to add dependencies permanently, you need to add them to <tt class="docutils literal">Dockerfile.ci</tt>. But you need to
do it indirectly via shell scripts that get automatically inlined in the <tt class="docutils literal">Dockerfile.ci</tt>. Those
scripts are present in <tt class="docutils literal">scripts/docker</tt> directory and are aptly (!) named <tt class="docutils literal"><span class="pre">install*.sh</span></tt>. Most
of the apt dependencies are installed in the <tt class="docutils literal">install_os_dependencies.sh</tt>, but some are installed in
other scripts (for example <tt class="docutils literal">install_postgres.sh</tt> or <tt class="docutils literal">install_mysql.sh</tt>).</p>
<p>After you modify the dependencies in the scripts, you need to inline them by running pre-commit:</p>
<pre class="code bash literal-block">
pre-commit<span class="whitespace"> </span>run<span class="whitespace"> </span>update-inlined-dockerfile-scripts<span class="whitespace"> </span>--all-files
</pre>
<p>You can also run the pre-commit by <tt class="docutils literal">breeze <span class="pre">static-checks</span> <span class="pre">--type</span> <span class="pre">update-inlined-dockerfile-scripts</span> <span class="pre">--all-files</span></tt>
command - which provides autocomplete.</p>
<p>After you've updated the dependencies, you need to rebuild the image:</p>
<p>Breeze will automatically detect when you updated dependencies and it will propose you to build image next
time when you enter it. You can answer <tt class="docutils literal">y</tt> during 10 seconds to get it done for you.</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>ci-image<span class="whitespace"> </span>build
</pre>
<p>Sometimes, when you have conflicting change in dependencies (i.e. dependencies in the old constraints
are conflicting with the new specification, you might want to build the image with
<tt class="docutils literal"><span class="pre">--upgrade-to-newer-dependencies</span></tt> flag:</p>
<pre class="code bash literal-block">
breeze<span class="whitespace"> </span>ci-image<span class="whitespace"> </span>build<span class="whitespace"> </span>--upgrade-to-newer-dependencies
</pre>
</div>
<div class="section" id="node-yarn-dependencies">
<h3><a class="toc-backref" href="#id130">Node (yarn) dependencies</a></h3>
<p>If you need to change &quot;node&quot; dependencies in <tt class="docutils literal">airflow/www</tt>, you need to compile them in the
host with <tt class="docutils literal">breeze <span class="pre">compile-www-assets</span></tt> command. No need to rebuild the image.</p>
</div>
</div>
</div>
<div class="section" id="recording-command-output">
<h1><a class="toc-backref" href="#id131">Recording command output</a></h1>
<p>Breeze uses built-in capability of <tt class="docutils literal">rich</tt> to record and print the command help as an <tt class="docutils literal">svg</tt> file.
It's enabled by setting <tt class="docutils literal">RECORD_BREEZE_OUTPUT_FILE</tt> to a file name where it will be recorded.
By default it records the screenshots with default characters width and with &quot;Breeze screenshot&quot; title,
but you can override it with <tt class="docutils literal">RECORD_BREEZE_WIDTH</tt> and <tt class="docutils literal">RECORD_BREEZE_TITLE</tt> variables respectively.</p>
</div>
<div class="section" id="uninstalling-breeze">
<h1><a class="toc-backref" href="#id132">Uninstalling Breeze</a></h1>
<p>Breeze was installed with <tt class="docutils literal">pipx</tt>, with <tt class="docutils literal">pipx list</tt>, you can list the installed packages.
Once you have the name of <tt class="docutils literal">breeze</tt> package you can proceed to uninstall it.</p>
<pre class="code bash literal-block">
pipx<span class="whitespace"> </span>list
</pre>
<p>This will also remove breeze from the folder: <tt class="docutils literal"><span class="pre">${HOME}.local/bin/</span></tt></p>
<pre class="code bash literal-block">
pipx<span class="whitespace"> </span>uninstall<span class="whitespace"> </span>apache-airflow-breeze
</pre>
</div>
<div class="section" id="debugging-developing-breeze">
<h1><a class="toc-backref" href="#id133">Debugging/developing Breeze</a></h1>
<p>Breeze can be quite easily debugged with PyCharm/VSCode or any other IDE - but it might be less discoverable
if you never tested modules and if you do not know how to bypass version check of breeze.</p>
<p>For testing, you can create your own virtual environment, or use the one that <tt class="docutils literal">pipx</tt> created for you if you
already installed breeze following the recommended <tt class="docutils literal">pipx install <span class="pre">-e</span> ./dev/breeze</tt> command.</p>
<p>For local virtualenv, you can use <tt class="docutils literal">pyenv</tt> or any other virtualenv wrapper. For example with <tt class="docutils literal">pyenv</tt>,
you can use <tt class="docutils literal">pyenv virtualenv 3.8.6 <span class="pre">airflow-breeze</span></tt> to create virtualenv called <tt class="docutils literal"><span class="pre">airflow-breeze</span></tt>
with Python 3.8.6. Then you can use <tt class="docutils literal">pyenv activate <span class="pre">airflow-breeze</span></tt> to activate it and install breeze
in editable mode with <tt class="docutils literal">pip install <span class="pre">-e</span> ./dev/breeze</tt>.</p>
<p>For <tt class="docutils literal">pipx</tt> virtualenv, you can use the virtualenv that <tt class="docutils literal">pipx</tt> created for you. You can find the name
where <tt class="docutils literal">pipx</tt> keeps their venvs via <tt class="docutils literal">pipx list</tt> command. Usually it is
<tt class="docutils literal"><span class="pre">${HOME}/.local/pipx/venvs/apache-airflow-breeze</span></tt> where <tt class="docutils literal">$HOME</tt> is your home directory.</p>
<p>The venv can be used for running breeze tests and for debugging breeze. While running tests should
be usually &quot;out-of-the-box&quot; for most IDEs, once you configure <tt class="docutils literal">./dev/breeze</tt> project to use the venv,
running/debugging a particular breeze command you want to debug might be a bit more tricky.</p>
<p>When you configure your &quot;Run/Debug configuration&quot; to run breeze command you should
make sure to follow these steps:</p>
<ul class="simple">
<li>pick one of the above interpreters to use (usually you need to choose <tt class="docutils literal">bin/python</tt> inside the venv)</li>
<li>choose <tt class="docutils literal">module</tt> to run and set it to <tt class="docutils literal">airflow_breeze.breeze</tt> - this is the entrypoint of breeze</li>
<li>add parameters you want to run breeze with (for example <tt class="docutils literal"><span class="pre">ci-image</span> build</tt> if you want to debug
how breeze builds the CI image</li>
<li>set <tt class="docutils literal">SKIP_BREEZE_SELF_UPGRADE_CHECK</tt> environment variable to <tt class="docutils literal">true</tt> to bypass built-in upgrade check of breeze,
this will bypass the check we run in Breeze to see if there are new requirements to install for it</li>
</ul>
<p>See example configuration for PyCharm which has run/debug configuration for
<tt class="docutils literal">breeze sbom <span class="pre">generate-providers-requirements</span> <span class="pre">--provider-id</span> sqlite <span class="pre">--python</span> 3.8</tt></p>
<div align="center">
    <img src="images/pycharm_debug_breeze.png" width="640"
         alt="Airflow Breeze - PyCharm debugger configuration">
</div><p>Then you can setup breakpoints and debug breeze as any other Python script or test.</p>
<p>Similar configuration can be done for VSCode.</p>
</div>
</div>
</body>
</html>
